name: GenHub Release

permissions:
  contents: write

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'
  CORE_PROJECT: 'GenHub/GenHub.Core/GenHub.Core.csproj'
  UI_PROJECT: 'GenHub/GenHub/GenHub.csproj'
  WINDOWS_PROJECT: 'GenHub/GenHub.Windows/GenHub.Windows.csproj'
  LINUX_PROJECT: 'GenHub/GenHub.Linux/GenHub.Linux.csproj'

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Extract Build Info
        id: buildinfo
        shell: pwsh
        run: |
          $version = "0.0.${{ github.run_number }}"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Inject Secrets
        shell: pwsh
        run: |
          ./.github/scripts/inject-token.ps1 -Token "${{ secrets.UPLOADTHING_TOKEN }}"

      - name: Publish Windows App
        shell: pwsh
        run: |
          dotnet publish "${{ env.WINDOWS_PROJECT }}" `
            -c ${{ env.BUILD_CONFIGURATION }} `
            -r win-x64 `
            --self-contained true `
            -o "win-publish" `
            -p:Version=${{ steps.buildinfo.outputs.VERSION }}

      - name: Install Velopack CLI
        shell: pwsh
        run: |
          dotnet tool install -g vpk
          echo "$HOME/.dotnet/tools" >> $env:GITHUB_PATH

      - name: Create Velopack Windows Package
        shell: pwsh
        run: |
          vpk pack `
            --packId GenHub `
            --packVersion ${{ steps.buildinfo.outputs.VERSION }} `
            --packDir win-publish `
            --mainExe GenHub.Windows.exe `
            --packTitle "GenHub" `
            --packAuthors "Community Outpost" `
            --icon GenHub/GenHub/Assets/Icons/generalshub.ico `
            --outputDir velopack-release-windows

          # Rename metadata to prevent collisions with Linux
          Rename-Item -Path "velopack-release-windows\releases.json" -NewName "releases.win.json" -ErrorAction SilentlyContinue
          Rename-Item -Path "velopack-release-windows\assets.json" -NewName "assets.win.json" -ErrorAction SilentlyContinue

      - name: Create Portable Windows Build
        shell: pwsh
        run: |
          $portableDir = "GenHub-Portable"
          New-Item -ItemType Directory -Force -Path $portableDir
          Copy-Item -Path "win-publish\*" -Destination $portableDir -Recurse -Force
          $zipName = "GenHub-${{ steps.buildinfo.outputs.VERSION }}-win-portable.zip"
          Compress-Archive -Path $portableDir -DestinationPath $zipName -Force

      - name: Upload Windows Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: velopack-release-windows/*
          retention-days: 1

      - name: Upload Windows Portable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: "GenHub-*-win-portable.zip"
          retention-days: 1

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Linux Dependencies
        run: sudo apt-get update && sudo apt-get install -y libgtk-3-dev libx11-dev

      - name: Inject Secrets
        shell: pwsh
        run: |
          ./.github/scripts/inject-token.ps1 -Token "${{ secrets.UPLOADTHING_TOKEN }}"

      - name: Publish Linux App
        run: |
          dotnet publish "${{ env.LINUX_PROJECT }}" \
            -c ${{ env.BUILD_CONFIGURATION }} \
            -r linux-x64 \
            --self-contained true \
            -o "linux-publish" \
            -p:Version="0.0.${{ github.run_number }}"

      - name: Install Velopack CLI
        run: |
          dotnet tool install -g vpk
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Create Velopack Linux Package
        run: |
          vpk pack \
            --packId GenHub \
            --packVersion "0.0.${{ github.run_number }}" \
            --packDir linux-publish \
            --mainExe GenHub.Linux \
            --packTitle "GenHub" \
            --packAuthors "Community Outpost" \
            --icon GenHub/GenHub/Assets/Icons/generalshub-icon.png \
            --outputDir velopack-release-linux

          # Rename metadata to prevent collisions with Windows
          mv velopack-release-linux/releases.json velopack-release-linux/releases.linux.json || true
          mv velopack-release-linux/assets.json velopack-release-linux/assets.linux.json || true

      - name: Upload Linux Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: velopack-release-linux/*
          retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Info
        id: info
        run: |
          VERSION="0.0.${{ github.run_number }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          git fetch --tags --force
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]' | head -n 1)
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" -10)
            COUNT="10"
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
            COUNT=$(git rev-list --count ${PREVIOUS_TAG}..HEAD)
          fi
          echo "COUNT=$COUNT" >> $GITHUB_OUTPUT
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Assets
        run: |
          mkdir final-assets
          # Copy only specific files to avoid duplicates
          # 1. Windows Setup and NuPkgs
          find artifacts/windows-release -type f \( -name "*.exe" -o -name "*.nupkg" -o -name "RELEASES" -o -name "*.json" \) -exec cp {} final-assets/ \;
          # 2. Linux NuPkgs and Json
          find artifacts/linux-release -type f \( -name "*.nupkg" -o -name "*.json" \) -exec cp {} final-assets/ \;
          # 3. Windows Portable (Specific match)
          cp artifacts/windows-portable/*.zip final-assets/

          ls -lh final-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.info.outputs.VERSION }}
          name: GenHub Alpha v${{ steps.info.outputs.VERSION }}
          prerelease: true
          body: |
            ## GenHub Alpha v${{ steps.info.outputs.VERSION }}

            ### ðŸ†• What's New
            **${{ steps.info.outputs.COUNT }} commits** included:
            ${{ steps.info.outputs.CHANGELOG }}

            ### ðŸ”§ Assets
            - **Installer:** [GenHub-win-Setup.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.info.outputs.VERSION }}/GenHub-win-Setup.exe)
            - **Portable:** [GenHub-${{ steps.info.outputs.VERSION }}-win-portable.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.info.outputs.VERSION }}/GenHub-${{ steps.info.outputs.VERSION }}-win-portable.zip)
          files: final-assets/*
