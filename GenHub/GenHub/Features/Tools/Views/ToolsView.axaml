<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:GenHub.Features.Tools.ViewModels"
             xmlns:interfaces="clr-namespace:GenHub.Core.Interfaces.Tools;assembly=GenHub.Core"
             xmlns:converters="clr-namespace:GenHub.Infrastructure.Converters"
             xmlns:controls="clr-namespace:GenHub.Common.Controls"
             xmlns:material="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             mc:Ignorable="d" d:DesignWidth="1100" d:DesignHeight="700"
             x:Class="GenHub.Features.Tools.Views.ToolsView"
             x:DataType="vm:ToolsViewModel"
             x:Name="Root">

  <UserControl.Resources>
    <converters:ObjectToBoolConverter x:Key="ObjectToBoolConverter" IsNullValue="False" IsNotNullValue="True" />
  </UserControl.Resources>

  <UserControl.Styles>
    <Style Selector="Border.tool-list-card">
      <Setter Property="Background" Value="{DynamicResource SystemChromeMediumLowColor}" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemChromeHighColor}" />
      <Setter Property="BorderThickness" Value="0,0,1,0" />
    </Style>

    <Style Selector="Border.tool-content-card">
      <Setter Property="Background" Value="Transparent" />
    </Style>

    <!-- Remove conflicting ListBoxItem styles to let global glassmorphic styles take over -->

    <Style Selector="Button.gradient-primary">
      <Setter Property="Background" Value="{StaticResource PurpleAccentGradient}" />
      <Setter Property="BorderBrush" Value="{StaticResource PurpleAccentBright}" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="CornerRadius" Value="0" />
      <Setter Property="Padding" Value="12,10" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="Foreground" Value="White" />
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15" Easing="CubicEaseOut"/>
        </Transitions>
      </Setter>
    </Style>

    <Style Selector="Button.gradient-primary:pointerover">
      <Setter Property="RenderTransform" Value="scale(1.02)" />

      <Setter Property="Background" Value="{StaticResource PurpleAccentGradient}" /> <!-- Keep gradient logic -->
    </Style>

    <Style Selector="Button.gradient-primary:pressed">
      <Setter Property="RenderTransform" Value="scale(0.98)" />

    </Style>

    <Style Selector="TextBlock.header">
      <Setter Property="FontSize" Value="24" />
      <Setter Property="FontWeight" Value="Bold" />
      <Setter Property="Foreground" Value="{DynamicResource SystemBaseHighColor}" />
    </Style>

    <Style Selector="TextBlock.subheader">
      <Setter Property="FontSize" Value="14" />
      <Setter Property="Foreground" Value="{DynamicResource SystemBaseMediumColor}" />
    </Style>

    <Style Selector="TextBlock.section-title">
      <Setter Property="FontSize" Value="16" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="Foreground" Value="{DynamicResource SystemBaseHighColor}" />
      <Setter Property="Margin" Value="0,0,0,10" />
    </Style>

    <Style Selector="Border.status-banner">
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="10,5" />
      <Setter Property="Margin" Value="20,0,0,0" />
    </Style>

    <Style Selector="Border.status-banner.success">
      <Setter Property="Background" Value="#2D5016" />
      <Setter Property="BorderBrush" Value="#4CAF50" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>

    <Style Selector="Border.status-banner.error">
      <Setter Property="Background" Value="#5C1A1A" />
      <Setter Property="BorderBrush" Value="#F44336" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>

    <Style Selector="Border.status-banner.info">
      <Setter Property="Background" Value="{DynamicResource SystemChromeMediumColor}" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemBaseLowColor}" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>
  </UserControl.Styles>

  <Grid>
    <controls:SidebarLayout PaneTitle="Installed Tools"
                            ItemsSource="{Binding InstalledTools}"
                            SelectedItem="{Binding SelectedTool}"
                            IsPaneOpen="{Binding IsPaneOpen, Mode=TwoWay}"
                            ItemTemplate="{StaticResource ToolItemTemplate}">

      <controls:SidebarLayout.Resources>
        <DataTemplate x:Key="ToolItemTemplate" DataType="interfaces:IToolPlugin">
            <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center" Margin="0,2">
             <material:MaterialIcon Grid.Column="0"
                                  Kind="Tools"
                                  Width="24"
                                  Height="24"
                                  Foreground="{StaticResource PurpleAccentBright}"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center"
                                  Margin="8,0,16,0"/>

             <StackPanel Grid.Column="1" Spacing="2" VerticalAlignment="Center">
              <TextBlock Text="{Binding Metadata.Name}" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
              <TextBlock Text="{Binding Metadata.Version, StringFormat='v{0}'}" FontSize="12" Opacity="0.7" Foreground="#BBBBBB" VerticalAlignment="Center"/>
             </StackPanel>
          </Grid>
        </DataTemplate>
      </controls:SidebarLayout.Resources>

      <controls:SidebarLayout.PaneHeader>
          <Button Margin="0,0,0,20"
                  Command="{Binding AddToolCommand}"
                  Background="#1AFFFFFF"
                  BorderBrush="#33FFFFFF"
                  BorderThickness="1"
                  CornerRadius="0"
                  HorizontalAlignment="Stretch"
                  Padding="10">
              <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                  <material:MaterialIcon Kind="Plus" Width="20" Height="20" Foreground="White"/>
                  <TextBlock Text="Add Tool" FontSize="14" FontWeight="SemiBold" Foreground="White"/>
              </StackPanel>
              <Button.Styles>
                  <Style Selector="Button:pointerover /template/ ContentPresenter">
                      <Setter Property="Background" Value="#1AFFFFFF"/>
                      <Setter Property="BorderBrush" Value="White"/>
                  </Style>
              </Button.Styles>
              <Button.Transitions>
                  <Transitions>
                      <BrushTransition Property="Background" Duration="0:0:0.2"/>
                      <BrushTransition Property="BorderBrush" Duration="0:0:0.2"/>
                  </Transitions>
              </Button.Transitions>
          </Button>
      </controls:SidebarLayout.PaneHeader>

      <controls:SidebarLayout.PaneFooter>
          <Button Command="{Binding RefreshToolsCommand}"
                  Background="#1AFFFFFF"
                  HorizontalAlignment="Stretch"
                  BorderBrush="#33FFFFFF"
                  BorderThickness="1"
                  CornerRadius="0"
                  Padding="10">
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
               <material:MaterialIcon Kind="Refresh" Width="16" Height="16" Foreground="{StaticResource PurpleAccentBright}"/>
               <TextBlock Text="Refresh Tools" HorizontalAlignment="Center" Foreground="White"/>
            </StackPanel>
          </Button>
      </controls:SidebarLayout.PaneFooter>

      <!-- Main Content -->
       <Grid RowDefinitions="Auto,*">

         <!-- Header / Status Area -->
         <Grid Grid.Row="0" Margin="20" ColumnDefinitions="Auto,*" >
           <TextBlock Text="{Binding SelectedTool.Metadata.Name, FallbackValue='GenHub Tools'}" Classes="header" />

           <!-- Status Messages -->
           <Border Grid.Column="1"
                   Classes="status-banner"
                   Classes.success="{Binding IsStatusSuccess}"
                   Classes.error="{Binding IsStatusError}"
                   Classes.info="{Binding IsStatusInfo}"
                   IsVisible="{Binding IsStatusVisible}">
              <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" Foreground="White" />
           </Border>
         </Grid>

         <!-- Content Area -->
         <Panel Grid.Row="1" Margin="10">
            <!-- Empty State -->
            <Grid IsVisible="{Binding SelectedTool, Converter={x:Static ObjectConverters.IsNull}}"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center">
                <StackPanel Spacing="20">
                    <material:MaterialIcon Kind="AutoFix" Width="64" Height="64" Foreground="#33FFFFFF" HorizontalAlignment="Center"/>
                    <TextBlock Text="Select a tool from the sidebar to view details"
                               FontSize="18"
                               Foreground="#66FFFFFF"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>

            <!-- Tool Content -->
            <Border Classes="tool-content-card" IsVisible="{Binding SelectedTool, Converter={x:Static ObjectConverters.IsNotNull}}">
               <ContentControl Content="{Binding CurrentToolControl}" />
            </Border>
         </Panel>
       </Grid>
    </controls:SidebarLayout>

    <!-- Details Dialog -->
    <Panel IsVisible="{Binding IsDetailsDialogOpen}" Background="#CC000000" ZIndex="100">
        <Border Background="{DynamicResource SystemChromeMediumColor}" CornerRadius="0" Padding="20" HorizontalAlignment="Center" VerticalAlignment="Center" MinWidth="400">
            <StackPanel Spacing="15">
                <TextBlock Text="Tool Details" FontSize="20" FontWeight="Bold" />
                <StackPanel Spacing="10" DataContext="{Binding ToolForDetails}">
                    <StackPanel>
                        <TextBlock Text="Name" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Name}" FontSize="16"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Version" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Version}"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Author" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Author}"/>
                    </StackPanel>
                    <StackPanel IsVisible="{Binding Metadata.Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="Description" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Description}" TextWrapping="Wrap"/>
                    </StackPanel>
                </StackPanel>
                <Button Command="{Binding CloseDetailsDialogCommand}" Content="Close" HorizontalAlignment="Right" />
            </StackPanel>
        </Border>
    </Panel>

  </Grid>
</UserControl>
