<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:GenHub.Features.Tools.ViewModels"
             xmlns:interfaces="clr-namespace:GenHub.Core.Interfaces.Tools;assembly=GenHub.Core"
             xmlns:converters="clr-namespace:GenHub.Infrastructure.Converters"
             mc:Ignorable="d" d:DesignWidth="1100" d:DesignHeight="700"
             x:Class="GenHub.Features.Tools.Views.ToolsView"
             x:DataType="vm:ToolsViewModel"
             x:Name="Root">

  <UserControl.Resources>
    <converters:ObjectToBoolConverter x:Key="ObjectToBoolConverter" IsNullValue="False" IsNotNullValue="True" />
  </UserControl.Resources>

  <UserControl.Styles>
    <Style Selector="Border.tool-list-card">
      <Setter Property="Background" Value="{DynamicResource SystemChromeMediumLowColor}" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemChromeHighColor}" />
      <Setter Property="BorderThickness" Value="0,0,1,0" />
    </Style>

    <Style Selector="Border.tool-content-card">
      <Setter Property="Background" Value="Transparent" />
    </Style>

    <Style Selector="ListBoxItem">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="Foreground" Value="{DynamicResource SystemBaseHighColor}" />
      <Setter Property="Padding" Value="12,12" />
      <Setter Property="Margin" Value="0,2" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="ClipToBounds" Value="False" />
    </Style>

    <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
      <Setter Property="Background" Value="{DynamicResource SystemListLowColor}" />
    </Style>

    <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
      <Setter Property="Background" Value="{DynamicResource SystemListMediumColor}" />
      <Setter Property="TextBlock.Foreground" Value="{DynamicResource SystemBaseHighColor}" />
    </Style>

    <Style Selector="Button.primary-button">
      <Setter Property="Background" Value="{DynamicResource SystemAccentColor}" />
      <Setter Property="Foreground" Value="#FFFFFF" />
      <Setter Property="Padding" Value="12,8" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="HorizontalContentAlignment" Value="Center" />
    </Style>

    <Style Selector="Button.primary-button:pointerover">
      <Setter Property="Background" Value="{DynamicResource SystemAccentColorLight1}" />
    </Style>

    <Style Selector="TextBlock.header">
      <Setter Property="FontSize" Value="24" />
      <Setter Property="FontWeight" Value="Bold" />
      <Setter Property="Foreground" Value="{DynamicResource SystemBaseHighColor}" />
    </Style>

    <Style Selector="TextBlock.subheader">
      <Setter Property="FontSize" Value="14" />
      <Setter Property="Foreground" Value="{DynamicResource SystemBaseMediumColor}" />
    </Style>

    <Style Selector="TextBlock.section-title">
      <Setter Property="FontSize" Value="16" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="Foreground" Value="{DynamicResource SystemBaseHighColor}" />
      <Setter Property="Margin" Value="0,0,0,10" />
    </Style>

    <Style Selector="Border.status-banner">
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="10,5" />
      <Setter Property="Margin" Value="20,0,0,0" />
    </Style>

    <Style Selector="Border.status-banner.success">
      <Setter Property="Background" Value="#2D5016" />
      <Setter Property="BorderBrush" Value="#4CAF50" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>

    <Style Selector="Border.status-banner.error">
      <Setter Property="Background" Value="#5C1A1A" />
      <Setter Property="BorderBrush" Value="#F44336" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>

    <Style Selector="Border.status-banner.info">
      <Setter Property="Background" Value="{DynamicResource SystemChromeMediumColor}" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemBaseLowColor}" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>
  </UserControl.Styles>

  <Grid>
    <!-- Main SplitView Area -->
    <SplitView IsPaneOpen="{Binding IsPaneOpen, Mode=TwoWay}"
               DisplayMode="Overlay"
               OpenPaneLength="300"
               PanePlacement="Left"
               Background="Transparent">

      <SplitView.Pane>
        <Border Classes="tool-list-card">
          <Grid RowDefinitions="Auto,Auto,*,Auto" Margin="15">
            <!-- Header -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,-5,0,5">
              <TextBlock Text="Installed Tools" Classes="section-title" VerticalAlignment="Center" Margin="0,10,0,0"/>
              <Button Grid.Column="1" Command="{Binding ClosePaneCommand}" Background="Transparent" BorderThickness="0" Padding="8" VerticalAlignment="Top">
                <TextBlock Text="✕" FontSize="18" FontWeight="Bold"/>
              </Button>
            </Grid>

            <!-- Add Tool -->
            <Button Grid.Row="1" Margin="0,0,0,15" Command="{Binding AddToolCommand}" Classes="primary-button" HorizontalAlignment="Stretch">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="➕" />
                    <TextBlock Text="Add Tool" />
                </StackPanel>
            </Button>

            <!-- Tool List -->
            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,0,0,15">
                <ListBox ItemsSource="{Binding InstalledTools}" SelectedItem="{Binding SelectedTool}" Background="Transparent">
                  <ListBox.ItemTemplate>
                    <DataTemplate x:DataType="interfaces:IToolPlugin">
                      <Grid ColumnDefinitions="*,Auto">
                        <StackPanel Grid.Column="0" Spacing="2">
                          <TextBlock Text="{Binding Metadata.Name}" FontWeight="SemiBold" />
                          <TextBlock Text="{Binding Metadata.Version, StringFormat='v{0}'}" FontSize="12" Opacity="0.6" />
                        </StackPanel>
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
            </ScrollViewer>

            <!-- Footer -->
            <Button Grid.Row="3" Command="{Binding RefreshToolsCommand}" Background="Transparent" HorizontalAlignment="Stretch" BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1">
              <TextBlock Text="Refresh Tools" HorizontalAlignment="Center"/>
            </Button>
          </Grid>
        </Border>
      </SplitView.Pane>

      <SplitView.Content>
         <Grid RowDefinitions="Auto,*">
           <!-- Click-outside to close overlay -->
           <Panel Grid.RowSpan="2" Background="Transparent"
                  IsVisible="{Binding IsPaneOpen}"
                  PointerPressed="OnContentPointerPressed" />
           <!-- Header / Status Area -->
           <Grid Grid.Row="0" Margin="20" ColumnDefinitions="Auto,*" >
             <TextBlock Text="{Binding SelectedTool.Metadata.Name, FallbackValue='Tools'}" Classes="header" />

             <!-- Status Messages -->
             <Border Grid.Column="1"
                     Classes="status-banner"
                     Classes.success="{Binding IsStatusSuccess}"
                     Classes.error="{Binding IsStatusError}"
                     Classes.info="{Binding IsStatusInfo}"
                     IsVisible="{Binding IsStatusVisible}">
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" Foreground="White" />
             </Border>
           </Grid>

           <!-- Content Area -->
           <Border Grid.Row="1" Classes="tool-content-card" Margin="10">
              <ContentControl Content="{Binding CurrentToolControl}" />
           </Border>
         </Grid>
      </SplitView.Content>
    </SplitView>

    <!-- Trigger Zone (Invisible Strip on Left) -->
    <!-- Only visible when pane is closed -->
    <Panel Width="15"
           HorizontalAlignment="Left"
           Background="Transparent"
           IsVisible="{Binding !IsPaneOpen}"
           PointerEntered="OnTriggerZonePointerEntered" />

    <!-- Details Dialog -->
    <Panel IsVisible="{Binding IsDetailsDialogOpen}" Background="#CC000000" ZIndex="100">
        <Border Background="{DynamicResource SystemChromeMediumColor}" CornerRadius="8" Padding="20" HorizontalAlignment="Center" VerticalAlignment="Center" MinWidth="400">
            <StackPanel Spacing="15">
                <TextBlock Text="Tool Details" FontSize="20" FontWeight="Bold" />
                <StackPanel Spacing="10" DataContext="{Binding ToolForDetails}">
                    <StackPanel>
                        <TextBlock Text="Name" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Name}" FontSize="16"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Version" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Version}"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Author" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Author}"/>
                    </StackPanel>
                    <StackPanel IsVisible="{Binding Metadata.Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="Description" FontWeight="Bold" Opacity="0.7"/>
                        <TextBlock Text="{Binding Metadata.Description}" TextWrapping="Wrap"/>
                    </StackPanel>
                </StackPanel>
                <Button Command="{Binding CloseDetailsDialogCommand}" Content="Close" HorizontalAlignment="Right" />
            </StackPanel>
        </Border>
    </Panel>

  </Grid>
</UserControl>
