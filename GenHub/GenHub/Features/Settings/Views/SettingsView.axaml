<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:GenHub.Features.Settings.ViewModels"
             xmlns:converters="clr-namespace:GenHub.Infrastructure.Converters;assembly=GenHub"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="GenHub.Features.Settings.Views.SettingsView"
             x:DataType="vm:SettingsViewModel"
             Focusable="True">

  <UserControl.Resources>
    <converters:NullableIntConverter x:Key="NullableIntConverter" />
    <converters:NullableDoubleConverter x:Key="NullableDoubleConverter" />
    <converters:TrustLevelToColorConverter x:Key="TrustLevelToColorConverter" />
  </UserControl.Resources>

  <UserControl.Styles>
    <Style Selector="Border.settings-card">
      <Setter Property="Background" Value="#2D2D30" />
      <Setter Property="CornerRadius" Value="8" />
      <Setter Property="Padding" Value="20" />
      <Setter Property="BorderBrush" Value="#3F3F46" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>

    <Style Selector="TextBlock.section-header">
      <Setter Property="FontSize" Value="18" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="Foreground" Value="#FFFFFF" />
      <Setter Property="Margin" Value="0,0,0,10" />
    </Style>

    <Style Selector="TextBlock.setting-label">
      <Setter Property="FontSize" Value="14" />
      <Setter Property="Foreground" Value="#E0E0E0" />
      <Setter Property="Margin" Value="0,0,0,5" />
    </Style>

    <Style Selector="TextBlock.setting-description">
      <Setter Property="FontSize" Value="12" />
      <Setter Property="Foreground" Value="#AAAAAA" />
      <Setter Property="TextWrapping" Value="Wrap" />
      <Setter Property="Margin" Value="0,2,0,0" />
    </Style>

    <Style Selector="Button.browse-button">
      <Setter Property="Background" Value="#404040" />
      <Setter Property="Foreground" Value="#FFFFFF" />
      <Setter Property="BorderBrush" Value="#606060" />
      <Setter Property="Padding" Value="12,6" />
      <Setter Property="CornerRadius" Value="4" />
    </Style>

    <Style Selector="Button.browse-button:pointerover">
      <Setter Property="Background" Value="#505050" />
    </Style>

    <Style Selector="Button.primary-button">
      <Setter Property="Background" Value="#7C4DFF" />
      <Setter Property="Foreground" Value="#FFFFFF" />
      <Setter Property="BorderBrush" Value="#9C27B0" />
      <Setter Property="Padding" Value="16,8" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="FontWeight" Value="SemiBold" />
    </Style>
    <Style Selector="Button.primary-button:pointerover">
      <Setter Property="Background" Value="#9C27B0" />
    </Style>

    <Style Selector="Button.secondary-button">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="Foreground" Value="#E0E0E0" />
      <Setter Property="BorderBrush" Value="#606060" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="Padding" Value="16,8" />
      <Setter Property="CornerRadius" Value="4" />
    </Style>

    <Style Selector="Button.secondary-button:pointerover">
      <Setter Property="Background" Value="#404040" />
    </Style>

    <Style Selector="TextBox">
      <Setter Property="Background" Value="#1E1E1E" />
      <Setter Property="Foreground" Value="#FFFFFF" />
      <Setter Property="BorderBrush" Value="#606060" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="8" />
    </Style>




    <!-- Custom ComboBox Style Inlined -->
    <Style Selector="ComboBox">
        <Setter Property="Background" Value="#333333" />
        <Setter Property="Foreground" Value="#E0E0E0" />
        <Setter Property="BorderBrush" Value="#444444" />
        <Setter Property="BorderThickness" Value="1" />
        <Setter Property="CornerRadius" Value="3" />
        <Setter Property="Padding" Value="12,8" />
        <Setter Property="HorizontalAlignment" Value="Stretch" />
        <Setter Property="VerticalAlignment" Value="Center" />
        <Setter Property="MinHeight" Value="36" />
        <Setter Property="PlaceholderForeground" Value="#999999" />
        <Setter Property="Template">
            <ControlTemplate>
                <Grid ColumnDefinitions="*,36">
                    <Border x:Name="Background"
                            Grid.Column="0"
                            Grid.ColumnSpan="2"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="{TemplateBinding CornerRadius}" />

                    <TextBlock x:Name="PlaceholderTextBlock"
                               Grid.Column="0"
                               Margin="{TemplateBinding Padding}"
                               HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                               VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                               Foreground="{TemplateBinding PlaceholderForeground}"
                               IsVisible="{TemplateBinding SelectionBoxItem, Converter={x:Static ObjectConverters.IsNull}}"
                               Text="{TemplateBinding PlaceholderText}" />

                    <ContentPresenter x:Name="ContentPresenter"
                                      Grid.Column="0"
                                      Margin="{TemplateBinding Padding}"
                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                      Content="{TemplateBinding SelectionBoxItem}"
                                      ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}" />

                    <PathIcon x:Name="DropDownGlyph"
                              Grid.Column="1"
                              Width="10"
                              Height="10"
                              Margin="0,0,12,0"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Center"
                              Data="M7,10L12,15L17,10H7Z"
                              Foreground="#CCCCCC"
                              UseLayoutRounding="False" />

                    <Popup x:Name="PART_Popup"
                           Grid.Column="0"
                           WindowManagerAddShadowHint="True"
                           Width="{Binding #Background.Bounds.Width}"
                           MaxHeight="{TemplateBinding MaxDropDownHeight}"
                           IsLightDismissEnabled="True"
                           IsOpen="{TemplateBinding IsDropDownOpen, Mode=TwoWay}"
                           PlacementTarget="{TemplateBinding}">
                        <Border x:Name="PopupBorder"
                                Background="#2D2D30"
                                BorderBrush="#444444"
                                BorderThickness="1"
                                CornerRadius="3"
                                Padding="2">
                            <ScrollViewer HorizontalScrollBarVisibility="{TemplateBinding ScrollViewer.HorizontalScrollBarVisibility}"
                                          VerticalScrollBarVisibility="{TemplateBinding ScrollViewer.VerticalScrollBarVisibility}">
                                <ItemsPresenter x:Name="PART_ItemsPresenter"
                                                ItemsPanel="{TemplateBinding ItemsPanel}" />
                            </ScrollViewer>
                        </Border>
                    </Popup>
                </Grid>
            </ControlTemplate>
        </Setter>
    </Style>

    <Style Selector="ComboBox:pointerover /template/ Border#Background">
        <Setter Property="Background" Value="#3E3E42" />
        <Setter Property="BorderBrush" Value="#555555" />
    </Style>

    <Style Selector="ComboBox:pointerover /template/ PathIcon#DropDownGlyph">
        <Setter Property="Foreground" Value="#FFFFFF" />
    </Style>

    <Style Selector="ComboBox:focus /template/ Border#Background">
        <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}" />
    </Style>

    <Style Selector="ComboBox:focus /template/ PathIcon#DropDownGlyph">
        <Setter Property="Foreground" Value="{DynamicResource SystemAccentColor}" />
    </Style>

    <Style Selector="ComboBox[IsDropDownOpen=true] /template/ Border#Background">
        <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}" />
        <Setter Property="Background" Value="#3E3E42" />
    </Style>

    <Style Selector="ComboBox[IsDropDownOpen=true] /template/ PathIcon#DropDownGlyph">
        <Setter Property="Foreground" Value="{DynamicResource SystemAccentColor}" />
        <Setter Property="RenderTransform" Value="rotate(180deg)" />
    </Style>

    <Style Selector="ComboBox:disabled">
        <Setter Property="Opacity" Value="0.5" />
    </Style>

    <Style Selector="ComboBoxItem">
        <Setter Property="Padding" Value="12,8" />
        <Setter Property="HorizontalAlignment" Value="Stretch" />
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="Foreground" Value="#F0F0F0" />
        <Setter Property="Margin" Value="0" />
        <Setter Property="CornerRadius" Value="2" />
    </Style>

    <Style Selector="ComboBoxItem:pointerover /template/ ContentPresenter">
        <Setter Property="Background" Value="#3E3E42" />
    </Style>

    <Style Selector="ComboBoxItem:selected /template/ ContentPresenter">
        <Setter Property="Background" Value="{DynamicResource SystemAccentColor}" />
        <Setter Property="Foreground" Value="#FFFFFF" />
    </Style>

    <Style Selector="ComboBoxItem:selected:pointerover /template/ ContentPresenter">
        <Setter Property="Background" Value="#A07C4DFF" />
    </Style>

    <Style Selector="CheckBox">
      <Setter Property="Foreground" Value="#E0E0E0" />
    </Style>

    <Style Selector="Border.notification">
      <Setter Property="Background" Value="#4CAF50" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="12,8" />
      <Setter Property="Margin" Value="0,0,0,10" />
      <Setter Property="IsVisible" Value="{Binding ShowSaveNotification}" />
    </Style>

    <Style Selector="Border.notification TextBlock">
      <Setter Property="Foreground" Value="#FFFFFF" />
      <Setter Property="FontWeight" Value="SemiBold" />
    </Style>

    <!-- Danger Zone Styles -->
    <Style Selector="Border.danger-zone-card">
      <Setter Property="BorderBrush" Value="#DC143C" />
      <Setter Property="BorderThickness" Value="2" />
      <Setter Property="Background" Value="#2D1A1A" />
      <Setter Property="Padding" Value="25" />
    </Style>

    <Style Selector="TextBlock.danger-header">
      <Setter Property="Foreground" Value="#FF6B6B" />
      <Setter Property="Margin" Value="0,0,0,15" />
    </Style>

    <Style Selector="Button.danger-button">
      <Setter Property="Background" Value="#8B0000" />
      <Setter Property="Foreground" Value="#FFFFFF" />
      <Setter Property="BorderBrush" Value="#DC143C" />
      <Setter Property="Padding" Value="12,8" />
      <Setter Property="HorizontalAlignment" Value="Stretch" />
      <Setter Property="HorizontalContentAlignment" Value="Center" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Transitions">
        <Transitions>
           <BrushTransition Property="Background" Duration="0:0:0.2" />
        </Transitions>
      </Setter>
    </Style>

    <Style Selector="Button.danger-button:pointerover">
      <Setter Property="Background" Value="#B22222" />
    </Style>
  </UserControl.Styles>

  <ScrollViewer Focusable="True">
    <StackPanel Margin="30" Spacing="25" MaxWidth="800">

      <!-- Header -->
      <StackPanel Spacing="5" Margin="0,0,0,10">
        <TextBlock Text="Settings" FontSize="32" FontWeight="Bold" Foreground="#FFFFFF" />
        <TextBlock Text="Configure your GenHub preferences and application behavior"
                   FontSize="16" Foreground="#AAAAAA" />
      </StackPanel>

      <!-- Save Notification -->
      <Border Classes="notification">
        <TextBlock Text="âœ“ Settings saved successfully!" />
      </Border>

      <!-- Game Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M7,5V19H17V5H7M7,3H17A2,2 0 0,1 19,5V19A2,2 0 0,1 17,21H7A2,2 0 0,1 5,19V5A2,2 0 0,1 7,3M9,7H15V9H9V7M9,11H15V13H9V11M9,15H15V17H9V15Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Game Configuration" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <!-- Default Workspace Strategy -->
            <StackPanel Spacing="8">
              <TextBlock Text="Default Workspace Strategy" Classes="setting-label" />
              <ComboBox ItemsSource="{Binding AvailableWorkspaceStrategies}"
                        SelectedItem="{Binding DefaultWorkspaceStrategy}"
                        HorizontalAlignment="Left"
                        MinWidth="250" />
              <TextBlock Text="Choose how files are managed in game workspaces"
                         Classes="setting-description" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Download Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Downloads" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <!-- Max Concurrent Downloads -->
            <StackPanel Spacing="8">
              <TextBlock Text="Maximum Concurrent Downloads" Classes="setting-label" />
              <NumericUpDown Value="{Binding MaxConcurrentDownloads}"
                             Minimum="1"
                             Maximum="10"
                             Increment="1"
                             HorizontalAlignment="Left"
                             Width="120"
                             FormatString="F0"
                             LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="Limit the number of simultaneous downloads to manage bandwidth usage (1-10)"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Download Buffer Size -->
            <StackPanel Spacing="8">
              <TextBlock Text="Download Buffer Size" Classes="setting-label" />
              <NumericUpDown Value="{Binding DownloadBufferSizeKB}"
                             Minimum="4"
                             Maximum="1024"
                             Increment="4"
                             HorizontalAlignment="Left"
                             Width="160"
                             FormatString="F0"
                             LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="Buffer size used for file downloads (4KB - 1MB, default: 80KB)"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Download Timeout -->
            <StackPanel Spacing="8">
              <TextBlock Text="Download Timeout" Classes="setting-label" />
              <NumericUpDown Value="{Binding DownloadTimeoutSeconds}"
                             Minimum="10"
                             Maximum="3600"
                             Increment="10"
                             HorizontalAlignment="Left"
                             Width="120"
                             FormatString="F0"
                             LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="Timeout for each download operation  (10-3600 seconds,default: 600 seconds)"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Download User-Agent -->
            <StackPanel Spacing="8">
              <TextBlock Text="Download User-Agent" Classes="setting-label" />
              <TextBox Text="{Binding DownloadUserAgent}"
                       Width="300"
                       LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="HTTP User-Agent string sent with download requests"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Background Downloads -->
            <StackPanel Spacing="8">
              <CheckBox Content="Allow background downloads"
                        IsChecked="{Binding AllowBackgroundDownloads}" />
              <TextBlock Text="Continue downloads when the application is minimized or in the background"
                         Classes="setting-description" Margin="24,0,0,0" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Application Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Appearance" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <!-- Theme Selection -->
            <StackPanel Spacing="8">
              <TextBlock Text="Theme" Classes="setting-label" />
              <ComboBox ItemsSource="{Binding AvailableThemes}"
                        SelectedItem="{Binding Theme}"
                        HorizontalAlignment="Left"
                        MinWidth="200" />
              <TextBlock Text="Select application color theme (More coming soon)"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Detailed Logging -->
            <StackPanel Spacing="8">
              <CheckBox Content="Enable detailed logging"
                        IsChecked="{Binding EnableDetailedLogging}" />
              <TextBlock Text="Enable verbose logging for troubleshooting. May impact performance."
                         Classes="setting-description" Margin="24,0,0,0" />
            </StackPanel>

            <!-- Auto Update Check -->
            <StackPanel Spacing="8">
              <CheckBox Content="Check for updates on startup"
                        IsChecked="{Binding AutoCheckForUpdatesOnStartup}" />
              <TextBlock Text="Automatically check for GenHub updates when the application starts"
                         Classes="setting-description" Margin="24,0,0,0" />
            </StackPanel>

            <!-- Settings File Path -->
            <StackPanel Spacing="8">
              <TextBlock Text="Settings File Location" Classes="setting-label" />
              <Grid ColumnDefinitions="*,Auto">
                <TextBox Grid.Column="0"
                         Text="{Binding SettingsFilePath}"
                         Watermark="Default (platform-dependent)"
                         LostFocus="OnTextBoxLostFocus" />
                <Button Grid.Column="1"
                        Content="Browse"
                        Command="{Binding BrowseSettingsFilePathCommand}"
                        Classes="browse-button" />
              </Grid>
              <TextBlock Text="Specify a custom location for your settings file. Leave empty for auto-detection."
                         Classes="setting-description" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Data Directories -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M20,6H12L10,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8A2,2 0 0,0 20,6M20,18H4V8H20V18Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Data Directories" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <TextBlock Text="Application Data Folders" Classes="setting-label" />

            <TextBlock Text="Quickly access application data, profiles, and manifests for troubleshooting or manual management."
                       Classes="setting-description" />

            <Grid ColumnDefinitions="*,10,*,10,*" RowDefinitions="Auto,10,Auto" Margin="0,10,0,0">
                <Button Grid.Row="0" Grid.Column="0"
                        Content="Open AppData"
                        Command="{Binding OpenAppDataDirectoryCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>

                <Button Grid.Row="0" Grid.Column="2"
                        Content="Open Profiles"
                        Command="{Binding OpenProfilesDirectoryCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>

                <Button Grid.Row="0" Grid.Column="4"
                        Content="Open Manifests"
                        Command="{Binding OpenManifestsDirectoryCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>

                <Button Grid.Row="2" Grid.Column="0"
                        Content="Open Workspaces"
                        Command="{Binding OpenWorkspacesDirectoryCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>

                <Button Grid.Row="2" Grid.Column="2"
                        Content="Open CAS Pool"
                        Command="{Binding OpenCasPoolDirectoryCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>
            </Grid>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Logs Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M16.5,16.5L13.5,19.5L12,18L13.5,16.5L12,15L13.5,13.5L12,12L13.5,10.5L15,12L16.5,10.5L18,12L16.5,13.5L18,15L16.5,16.5Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Logs" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <TextBlock Text="Application Logs" Classes="setting-label" />

            <TextBlock Text="Access diagnostic logs to help troubleshoot issues or report bugs."
                       Classes="setting-description" />

            <Grid ColumnDefinitions="*,10,*,10,*" Margin="0,10,0,0">
                <Button Grid.Column="0"
                        Content="Open Logs Directory"
                        Command="{Binding OpenLogsDirectoryCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>

                <Button Grid.Column="2"
                        Content="Open Latest Log"
                        Command="{Binding OpenLatestLogCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>

                <Button Grid.Column="4"
                        Content="Copy Latest Log Content"
                        Command="{Binding CopyLatestLogCommand}"
                        Classes="secondary-button" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"/>
            </Grid>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Performance Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M13,3A9,9 0 0,0 4,12H1L4.89,16.89L4.96,17L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Performance" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <!-- Memory Usage Info -->
            <StackPanel Spacing="8">
              <TextBlock Text="Memory Usage" Classes="setting-label" />
              <TextBlock Text="{Binding CurrentMemoryUsage, StringFormat='Current: {0:F1} MB'}"
                         Foreground="#AAAAAA" FontSize="14" />
              <TextBlock Text="Monitor application memory consumption"
                         Classes="setting-description" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Content-Addressable Storage (CAS) Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M2,6H6V18H2V6M9,6H13V18H9V6M16,6H20V18H16V6Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Content-Addressable Storage (CAS)" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <!-- CAS Root Path -->
            <StackPanel Spacing="8">
              <TextBlock Text="CAS Root Directory" Classes="setting-label" />
              <Grid ColumnDefinitions="*,Auto">
                <TextBox Grid.Column="0"
                         Text="{Binding CasRootPath}"
                         Watermark="Default (%AppData%/GenHub/cas-pool)"
                         LostFocus="OnTextBoxLostFocus" />
                <Button Grid.Column="1"
                        Content="Browse"
                        Command="{Binding BrowseCasRootPathCommand}"
                        Classes="browse-button" />
              </Grid>
              <TextBlock Text="Directory where deduplicated content is stored. All workspaces reference files from here."
                         Classes="setting-description" />
            </StackPanel>

            <!-- Max Cache Size -->
            <StackPanel Spacing="8">
              <TextBlock Text="Maximum Cache Size (GB)" Classes="setting-label" />
              <NumericUpDown Value="{Binding MaxCacheSizeGB}"
                             Minimum="1"
                             Maximum="1000"
                             Increment="5"
                             HorizontalAlignment="Left"
                             Width="120"
                             FormatString="F0"
                             LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="Maximum size for the CAS pool before garbage collection runs (1-1000 GB)"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Max Concurrent Operations -->
            <StackPanel Spacing="8">
              <TextBlock Text="Maximum Concurrent CAS Operations" Classes="setting-label" />
              <NumericUpDown Value="{Binding CasMaxConcurrentOperations}"
                             Minimum="1"
                             Maximum="16"
                             Increment="1"
                             HorizontalAlignment="Left"
                             Width="120"
                             FormatString="F0"
                             LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="Number of simultaneous CAS operations (1-16, default: 4)"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Garbage Collection Settings -->
            <StackPanel Spacing="8">
              <CheckBox Content="Enable automatic garbage collection"
                        IsChecked="{Binding EnableAutomaticGc}" />
              <TextBlock Text="Automatically clean up unreferenced content to free disk space"
                         Classes="setting-description" Margin="24,0,0,0" />
            </StackPanel>

            <StackPanel Spacing="8" IsVisible="{Binding EnableAutomaticGc}">
              <TextBlock Text="Garbage Collection Grace Period (Days)" Classes="setting-label" />
              <NumericUpDown Value="{Binding GarbageCollectionGracePeriodDays}"
                             Minimum="1"
                             Maximum="365"
                             Increment="1"
                             HorizontalAlignment="Left"
                             Width="120"
                             FormatString="F0"
                             LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="How long to keep unreferenced content before deletion (1-365 days)"
                         Classes="setting-description" />
            </StackPanel>

            <StackPanel Spacing="8" IsVisible="{Binding EnableAutomaticGc}">
              <TextBlock Text="Auto GC Interval (Days)" Classes="setting-label" />
              <NumericUpDown Value="{Binding AutoGcIntervalDays}"
                             Minimum="1"
                             Maximum="30"
                             Increment="1"
                             HorizontalAlignment="Left"
                             Width="120"
                             FormatString="F0"
                             LostFocus="OnTextBoxLostFocus" />
              <TextBlock Text="How often to run automatic garbage collection (1-30 days)"
                         Classes="setting-description" />
            </StackPanel>

            <!-- Integrity Verification -->
            <StackPanel Spacing="8">
              <CheckBox Content="Verify file integrity during operations"
                        IsChecked="{Binding CasVerifyIntegrity}" />
              <TextBlock Text="Check file hashes to ensure data integrity (recommended, slight performance impact)"
                         Classes="setting-description" Margin="24,0,0,0" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Expander>



      <!-- Content Directories -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M19,20H5V4H7V7H17V4H19M12,2A1,1 0 0,1 13,3A1,1 0 0,1 12,4A1,1 0 0,1 11,3A1,1 0 0,1 12,2M19,2H17V2H7V2H5A2,2 0 0,0 3,4V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V4A2,2 0 0,0 19,2Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="Local Content Directories" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <StackPanel Spacing="8">
              <TextBlock Text="Content Directories (one per line)" Classes="setting-label" />
              <TextBox Text="{Binding ContentDirectoriesText}" AcceptsReturn="True" Height="80" Watermark="e.g. C:\Games\GenHub\Mods" />
              <TextBlock Text="Specify directories to scan for local content. One path per line." Classes="setting-description" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Expander>

      <!-- GitHub Discovery Repositories -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"
                          Width="16" Height="16" Foreground="#E0E0E0"/>
                <TextBlock Text="GitHub Discovery" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <StackPanel Spacing="8">
              <TextBlock Text="GitHub Repositories (one per line, owner/repo)" Classes="setting-label" />
              <TextBox Text="{Binding GitHubDiscoveryRepositoriesText}" AcceptsReturn="True" Height="80" Watermark="e.g. some-author/some-mod" />
              <TextBlock Text="Specify GitHub repositories to scan for releases. One owner/repo per line." Classes="setting-description" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Expander>


      <!-- Update Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="ðŸ”„" FontSize="16" VerticalAlignment="Center"/>
                <TextBlock Text="Updates" Classes="section-header" Margin="0"/>
            </StackPanel>
        </Expander.Header>
      <Border Classes="settings-card">
        <StackPanel Spacing="20">

          <!-- Current Version -->
          <StackPanel Spacing="4">
            <TextBlock Text="Current Version" Classes="setting-label" />
            <TextBlock Text="{Binding CurrentVersion}" FontSize="14" Foreground="#67B26F" FontWeight="SemiBold" />
          </StackPanel>



            <!-- Subscribed Branch -->
            <StackPanel Spacing="8">
              <TextBlock Text="Subscribed Branch" Classes="setting-label" />
              <TextBlock Text="Manage your branch subscription in the Updates &amp; PRs window."
                         Classes="setting-description" />
            </StackPanel>

            <!-- Manage Updates & PRs Button -->
            <Button Content="Manage Updates &amp; PRs"
                    Command="{Binding OpenUpdateWindowCommand}"
                    Classes="browse-button"
                    HorizontalAlignment="Left"
                    Margin="0,8,0,0"
                    ToolTip.Tip="Browse available updates and subscribe to Pull Requests" />


          <!-- GitHub PAT for Artifact Access -->
          <Border Background="#1E1E1E" CornerRadius="4" Padding="15" BorderBrush="#4E4E4E" BorderThickness="1">
            <StackPanel Spacing="12">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="ðŸ”‘" FontSize="16" VerticalAlignment="Center" />
                <TextBlock Text="GitHub Personal Access Token (for Artifact Updates)"
                           Classes="setting-label" VerticalAlignment="Center" Margin="0" />
              </StackPanel>

              <!-- PAT Status -->
              <StackPanel Orientation="Horizontal" Spacing="8">
                 <Ellipse Width="8" Height="8" VerticalAlignment="Center"
                          Fill="{Binding PatStatusColor}">
                 </Ellipse>
                <TextBlock Text="{Binding PatStatusMessage}" Foreground="#AAAAAA" FontSize="12" />
              </StackPanel>

              <!-- PAT Input -->
              <Grid ColumnDefinitions="*,Auto,Auto" IsVisible="{Binding !HasGitHubPat}">
                <TextBox Grid.Column="0"
                         Text="{Binding GitHubPatInput}"
                         PasswordChar="â—"
                         Watermark="ghp_xxxxxxxxxxxxxxxxxxxx"
                         Margin="0,0,8,0" />
                <Button Grid.Column="1"
                        Content="Save &amp; Test"
                        Command="{Binding TestPatCommand}"
                        IsEnabled="{Binding !IsTestingPat}"
                        Classes="browse-button" />
              </Grid>

              <!-- Delete PAT button (when PAT exists) -->
              <StackPanel Orientation="Horizontal" Spacing="10" IsVisible="{Binding HasGitHubPat}">
                <Button Content="Remove PAT"
                        Command="{Binding DeletePatCommand}"
                        Classes="secondary-button" />
                <Button Content="Refresh Artifacts"
                        Command="{Binding LoadArtifactsCommand}"
                        IsEnabled="{Binding !IsLoadingArtifacts}"
                        Classes="browse-button" />
              </StackPanel>

              <StackPanel Orientation="Horizontal" Spacing="12">
                <TextBlock Text="PAT with 'repo' scope required for CI artifact access."
                           Classes="setting-description" VerticalAlignment="Center" />
                <Button Content="Create PAT â†’"
                        Click="OnOpenPatCreationUrl"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="0"
                        Foreground="#7C4DFF"
                        FontSize="12"
                        Cursor="Hand"
                        ToolTip.Tip="Click to open GitHub PAT creation page" />
              </StackPanel>
            </StackPanel>
          </Border>

          <!-- Available Artifacts (for PAT users) -->
          <StackPanel Spacing="8" IsVisible="{Binding HasGitHubPat}">
            <TextBlock Text="Available CI Artifacts" Classes="setting-label" />
            <ItemsControl ItemsSource="{Binding AvailableArtifacts}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Background="#3D3D3D" CornerRadius="4" Padding="12" Margin="0,4">
                    <Grid ColumnDefinitions="*,Auto">
                      <StackPanel Grid.Column="0" Spacing="4">
                        <TextBlock Text="{Binding DisplayVersion}" FontWeight="SemiBold" Foreground="#FFFFFF" />
                        <StackPanel Orientation="Horizontal" Spacing="8">
                          <TextBlock Text="{Binding CreatedAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"
                                     Foreground="#AAAAAA" FontSize="11" />
                          <TextBlock Text="{Binding ArtifactName}"
                                     Foreground="#888888" FontSize="11" />
                        </StackPanel>
                      </StackPanel>
                      <Button Grid.Column="1"
                              Content="View Run â†’"
                              Classes="browse-button"
                              Click="OnViewWorkflowRun"
                              Tag="{Binding WorkflowRunUrl}" />
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
            <TextBlock Text="No artifacts available"
                       IsVisible="{Binding !AvailableArtifacts.Count}"
                       Foreground="#888888" FontStyle="Italic" />
          </StackPanel>
        </StackPanel>
      </Border>
      </Expander>
      <!-- Subscriptions Settings -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch">
        <Expander.Header>
          <Grid ColumnDefinitions="*,Auto">
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
              <PathIcon Data="M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z"
                        Width="16" Height="16" Foreground="#E0E0E0"/>
              <TextBlock Text="Catalog Subscriptions" Classes="section-header" Margin="0" VerticalAlignment="Center"/>
            </StackPanel>
            <Button Grid.Column="1"
                    Content="Refresh All"
                    Command="{Binding RefreshAllCatalogsCommand}"
                    IsEnabled="{Binding !IsLoadingSubscriptions}"
                    Classes="secondary-button"
                    Padding="12,4"
                    FontSize="12"
                    Margin="0,0,10,0"
                    VerticalAlignment="Center"/>
          </Grid>
        </Expander.Header>
        <Border Classes="settings-card">
          <StackPanel Spacing="20">
            <TextBlock Text="Manage your subscribed content catalogs." Classes="setting-description" />

            <ItemsControl ItemsSource="{Binding Subscriptions}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Background="#1E1E1E" CornerRadius="8" Padding="12" Margin="0,0,0,10" BorderBrush="#333333" BorderThickness="1">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                      <!-- Publisher Icon/Avatar -->
                      <Border Grid.Column="0" Width="40" Height="40" CornerRadius="20" ClipToBounds="True" Background="#333333" Margin="0,0,12,0">
                         <Image Source="{Binding AvatarUrl, Converter={StaticResource StringToImageConverter}}" Stretch="UniformToFill" />
                      </Border>

                      <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding PublisherName}" FontWeight="SemiBold" Foreground="White" FontSize="14"/>
                        <TextBlock Text="{Binding CatalogUrl}" Foreground="#888888" FontSize="11" TextTrimming="CharacterEllipsis"/>
                      </StackPanel>

                      <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                        <!-- Trust Toggle Button -->
                        <Button Content="{Binding TrustLevel}"
                                Command="{Binding $parent[UserControl].((vm:SettingsViewModel)DataContext).ToggleSubscriptionTrustCommand}"
                                CommandParameter="{Binding}"
                                Classes="secondary-button"
                                Padding="8,4"
                                FontSize="12">
                          <Button.Styles>
                            <Style Selector="Button">
                              <Setter Property="Foreground" Value="{Binding TrustLevel, Converter={x:Static converters:TrustLevelToColorConverter.Instance}}" />
                            </Style>
                          </Button.Styles>
                        </Button>

                        <!-- Remove Button -->
                        <Button Content="Remove"
                                Command="{Binding $parent[UserControl].((vm:SettingsViewModel)DataContext).RemoveSubscriptionCommand}"
                                CommandParameter="{Binding}"
                                Classes="danger-button"
                                Padding="8,4"
                                FontSize="12"/>
                      </StackPanel>
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>

            <TextBlock Text="No active subscriptions found. You can subscribe to catalogs via 'genhub://subscribe' links."
                       IsVisible="{Binding !Subscriptions.Count}"
                       Foreground="#888888" FontStyle="Italic" HorizontalAlignment="Center" Margin="0,10"/>
          </StackPanel>
        </Border>
      </Expander>

      <!-- Danger Zone -->
      <Expander IsExpanded="False" HorizontalAlignment="Stretch" Margin="0,20,0,0">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="10">
                <PathIcon Data="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"
                          Width="16" Height="16" Foreground="#FF6B6B"/>
                <TextBlock Text="Danger Zone" Classes="section-header" Margin="0" Foreground="#FF6B6B"/>
            </StackPanel>
        </Expander.Header>
          <Border Classes="settings-card danger-zone-card">
            <StackPanel Spacing="20">
              <TextBlock Text="âš ï¸ Danger Zone" Classes="section-header danger-header" />

              <!-- Real-time Stats -->
              <StackPanel Spacing="10">
                <TextBlock Text="Current Data Usage:" FontWeight="SemiBold" Foreground="#FF6B6B" />
                <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" Margin="10,0,0,0">
                  <TextBlock Grid.Row="0" Grid.Column="0" Text="CAS Storage:" Width="150" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                  <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding CasStorageInfo}" Foreground="#E0E0E0" Margin="0,0,0,5"/>

                  <TextBlock Grid.Row="1" Grid.Column="0" Text="Manifests:" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                  <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ManifestsInfo}" Foreground="#E0E0E0" Margin="0,0,0,5"/>

                  <TextBlock Grid.Row="2" Grid.Column="0" Text="Workspaces:" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                  <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding WorkspacesInfo}" Foreground="#E0E0E0" Margin="0,0,0,5"/>

                  <TextBlock Grid.Row="3" Grid.Column="0" Text="Profiles:" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                  <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ProfilesInfo}" Foreground="#E0E0E0" Margin="0,0,0,5"/>
                </Grid>
              </StackPanel>

              <!-- Deletion Buttons -->
              <StackPanel Spacing="10">
                <TextBlock Text="Destructive Actions:" FontWeight="SemiBold" Foreground="#FF6B6B" Margin="0,10,0,0" />
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" Margin="0,10">
                    <Button Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                            Content="Uninstall GenHub (Keep Data)"
                            Command="{Binding UninstallGenHubCommand}"
                            ToolTip.Tip="Uninstall does not delete data only uninstalls GenHub"
                            Classes="danger-button" Margin="0,0,0,10"/>

                    <StackPanel Grid.Row="1" Grid.Column="0" Spacing="10" Margin="0,0,10,0">
                        <Button Content="Delete CAS Storage"
                                Command="{Binding DeleteCasStorageCommand}"
                                ToolTip.Tip="Deletes all cached game files"
                                Classes="danger-button" />
                        <Button Content="Delete Manifests"
                                Command="{Binding DeleteManifestsCommand}"
                                ToolTip.Tip="Removes all content metadata"
                                Classes="danger-button" />
                    </StackPanel>
                    <StackPanel Grid.Row="1" Grid.Column="1" Spacing="10" Margin="10,0,0,0">
                        <Button Content="Delete Workspaces"
                                Command="{Binding DeleteWorkspacesCommand}"
                                ToolTip.Tip="Cleans up all temporary game workspaces"
                                Classes="danger-button" />
                        <Button Content="Delete Profiles"
                                Command="{Binding DeleteProfilesCommand}"
                                ToolTip.Tip="Permanently removes all user profiles"
                                Classes="danger-button" />
                    </StackPanel>
                </Grid>

                <Separator Margin="0,10" Background="#DC143C" Height="1" Opacity="0.3"/>

                <Button Content="âš ï¸ DELETE ALL APPLICATION DATA âš ï¸"
                        Command="{Binding DeleteAllDataCommand}"
                        Classes="danger-button"
                        HorizontalAlignment="Stretch"
                        FontWeight="Bold"
                        FontSize="14"/>
              </StackPanel>
            </StackPanel>
          </Border>
      </Expander>



      <!-- Action Buttons -->
      <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Right" Margin="0,10,0,0">
        <Button Content="Reset to Defaults"
                Command="{Binding ResetToDefaultsCommand}"
                Classes="secondary-button"
                IsEnabled="{Binding !IsSaving}" />
        <Button Content="{Binding SaveButtonText}"
                Command="{Binding SaveSettingsCommand}"
                Classes="primary-button"
                IsEnabled="{Binding !IsSaving}" />
      </StackPanel>

      <!-- Footer Info -->
      <Border Background="#2D2D30" CornerRadius="4" Padding="15" Margin="0,20,0,0">
        <StackPanel Orientation="Horizontal" Spacing="10">
          <TextBlock Text="ðŸ’¡" FontSize="16" />
          <TextBlock Text="Settings are automatically saved and will take effect immediately or on next restart as needed."
                     Foreground="#AAAAAA" FontSize="12" TextWrapping="Wrap" />
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
</UserControl>
