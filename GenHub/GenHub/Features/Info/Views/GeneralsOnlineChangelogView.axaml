<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:GenHub.Features.Info.ViewModels"
             xmlns:material="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:controls="clr-namespace:GenHub.Infrastructure.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="GenHub.Features.Info.Views.GeneralsOnlineChangelogView"
             x:DataType="vm:GeneralsOnlineChangelogViewModel">

  <StackPanel>
    <!-- Header / Refresh -->
    <Grid ColumnDefinitions="*, Auto" Margin="0,0,0,20">
       <StackPanel>
         <TextBlock Text="Generals Online Patch Notes" FontSize="20" FontWeight="Bold" Foreground="White"/>
         <TextBlock Text="Latest updates and changes" FontSize="14" Foreground="#888888"/>
       </StackPanel>
       <Button Grid.Column="1" Command="{Binding LoadPatchNotesCommand}"
               IsEnabled="{Binding !IsLoading}"
               Padding="8,4" Background="#33FFFFFF" CornerRadius="4">
           <StackPanel Orientation="Horizontal" Spacing="6">
               <material:MaterialIcon Kind="Refresh" Width="16" Height="16"/>
               <TextBlock Text="Refresh"/>
           </StackPanel>
       </Button>
    </Grid>

    <!-- Loading State -->
    <ProgressBar IsIndeterminate="True"
                 IsVisible="{Binding IsLoading}"
                 Margin="0,20"/>

    <!-- Error State -->
    <Border Background="#33FF0000"
            BorderBrush="#FF5555"
            BorderThickness="1"
            CornerRadius="6"
            Padding="16"
            IsVisible="{Binding HasError}"
            Margin="0,0,0,20">
        <StackPanel Orientation="Horizontal" Spacing="12">
            <material:MaterialIcon Kind="AlertCircle" Foreground="#FF5555" Width="24" Height="24"/>
            <TextBlock Text="{Binding ErrorMessage}" VerticalAlignment="Center" Foreground="#FF5555"/>
        </StackPanel>
    </Border>

    <!-- List -->
    <ItemsControl ItemsSource="{Binding PatchNotes}">
       <ItemsControl.ItemTemplate>
          <DataTemplate>
             <Border Background="#1E1E1E" CornerRadius="8" Margin="0,0,0,12"
                     BorderBrush="#33FFFFFF" BorderThickness="1" ClipToBounds="True">
                <StackPanel>
                    <!-- Header (Interactive Toggle) -->
                    <Button Command="{Binding ((vm:GeneralsOnlineChangelogViewModel)DataContext).ToggleExpansionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            Background="Transparent" BorderThickness="0" Padding="16"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                        <Grid ColumnDefinitions="*, Auto">
                            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Title}" FontSize="16" FontWeight="Bold" Foreground="{StaticResource SystemAccentColorBrush}"/>
                                <TextBlock Text="{Binding Date}"
                                           FontSize="13" Foreground="#888888" VerticalAlignment="Center"/>
                            </StackPanel>
                            <material:MaterialIcon Grid.Column="1"
                                                    Kind="{Binding IsExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                                    Width="20" Height="20" Foreground="#666"
                                                    VerticalAlignment="Center"/>
                        </Grid>
                    </Button>

                    <!-- Summary (Always visible) -->
                    <TextBlock Text="{Binding Summary}" FontSize="14" FontWeight="SemiBold" Margin="16,0,16,16" Foreground="#DDDDDD" TextWrapping="Wrap"/>

                    <!-- Separator (Visible only when expanded) -->
                    <Border Height="1" Background="#22FFFFFF" Margin="16,0" IsVisible="{Binding IsExpanded}"/>

                    <!-- Expanded Body (Changes) -->
                    <Border IsVisible="{Binding IsExpanded}" Padding="16">
                        <StackPanel Spacing="10">
                            <!-- Loading State for Details -->
                            <StackPanel IsVisible="{Binding IsLoadingDetails}" Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center" Margin="0,10">
                                <ProgressBar IsIndeterminate="True" Width="100" VerticalAlignment="Center"/>
                                <TextBlock Text="Fetching details..." FontSize="12" Foreground="#888"/>
                            </StackPanel>

                            <!-- Changes List -->
                            <ItemsControl ItemsSource="{Binding Changes}" IsVisible="{Binding IsDetailsLoaded}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="0,2" Spacing="8">
                                            <TextBlock Text="â€¢" Foreground="{StaticResource SystemAccentColorBrush}" VerticalAlignment="Top"/>
                                            <TextBlock Text="{Binding}" Foreground="#CCCCCC" TextWrapping="Wrap" FontSize="13"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Details URL (Optional) -->
                            <Button HorizontalAlignment="Right"
                                    Command="{Binding ((vm:GeneralsOnlineChangelogViewModel)DataContext).OpenReleaseUrlCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    CommandParameter="{Binding DetailsUrl}"
                                    IsVisible="{Binding IsDetailsLoaded}"
                                    Background="Transparent" Padding="4">
                                 <StackPanel Orientation="Horizontal" Spacing="4">
                                     <TextBlock Text="View source" FontSize="11" Foreground="#666"/>
                                     <material:MaterialIcon Kind="OpenInNew" Width="14" Height="14" Foreground="#666"/>
                                 </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                </StackPanel>
             </Border>
          </DataTemplate>
       </ItemsControl.ItemTemplate>
    </ItemsControl>
  </StackPanel>
</UserControl>
