<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:GenHub.Features.AppUpdate.ViewModels"
             xmlns:cv="using:GenHub.Infrastructure.Converters"
             x:Class="GenHub.Features.AppUpdate.Views.UpdateNotificationView"
             x:DataType="vm:UpdateNotificationViewModel"
             x:Name="Root">

    <UserControl.Resources>
        <cv:IsSubscribedConverter x:Key="IsSubscribedConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <Style Selector="TabItem">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Foreground" Value="#AAAAAA"/>
            <Setter Property="Margin" Value="0,0,0,12"/>
        </Style>
        <Style Selector="TabItem:selected">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <!-- Subscribe Button Style handling state via Tag binding -->
        <Style Selector="Button.SubscribeState">
            <Setter Property="Content" Value="Subscribe"/>
            <Setter Property="IsEnabled" Value="True"/>
        </Style>
        <Style Selector="Button.SubscribeState[Tag=True]">
            <Setter Property="Content" Value="Subscribed"/>
            <Setter Property="IsEnabled" Value="False"/>
            <Setter Property="Background" Value="#207C4DFF"/>
            <Setter Property="Foreground" Value="#CC7C4DFF"/>
            <Setter Property="BorderBrush" Value="#7C4DFF"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*,Auto" Margin="20,12">

        <!-- Tabs for Update vs Browse -->
        <TabControl Grid.Row="1" Background="Transparent" Margin="-8,0">
            <TabItem Header="Update">
                <StackPanel Spacing="16" Margin="8,0">
                    <!-- Update Status Card -->
                    <Border Background="#20FFFFFF" CornerRadius="12" Padding="20" IsVisible="{Binding IsUpdateAvailable}">
                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto">
                            <!-- Icon -->
                            <Border Grid.RowSpan="2" Width="48" Height="48" CornerRadius="24" Background="#7C4DFF" Margin="0,0,16,0" VerticalAlignment="Top">
                                <Viewbox Width="24" Height="24">
                                    <Path Data="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z" Fill="White" />
                                </Viewbox>
                            </Border>

                            <!-- Title & Version -->
                            <StackPanel Grid.Column="1">
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBlock Text="Update Available!" FontSize="18" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                                    <!-- Force Refresh Button inside the card -->
                                    <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="4">
                                         <Button Command="{Binding ForceRefreshCommand}"
                                                Background="Transparent" BorderThickness="0" Padding="8"
                                                ToolTip.Tip="Force Refresh Updates">
                                            <PathIcon Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.86,17.45 19.71,14H17.58C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                                                      Foreground="#AAAAAA" Width="16" Height="16"/>
                                        </Button>
                                        <Button Command="{Binding DismissCommand}"
                                                Background="Transparent" BorderThickness="0" Padding="8"
                                                ToolTip.Tip="Dismiss Update">
                                            <PathIcon Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"
                                                      Foreground="#AAAAAA" Width="16" Height="16"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                                <TextBlock Text="{Binding DisplayLatestVersion, StringFormat='Version {0} is ready'}" FontSize="14" Foreground="#CCFFFFFF" Margin="0,4,0,0"/>
                            </StackPanel>

                            <!-- Release Notes Link -->
                            <Button Grid.Row="1" Grid.Column="1" Content="View Release Notes" Command="{Binding ViewReleaseNotesCommand}"
                                    Background="Transparent" Foreground="#7C4DFF" BorderThickness="0" Padding="0" Margin="0,8,0,0" HorizontalAlignment="Left" Cursor="Hand"/>
                        </Grid>
                    </Border>

                    <!-- Settings / Subscription Info -->
                    <Border Background="#15FFFFFF" CornerRadius="12" Padding="16">
                        <StackPanel Spacing="12">
                            <TextBlock Text="Installation Source" FontSize="14" FontWeight="SemiBold" Foreground="White"/>

                            <!-- Current Source Display (Fixed overlapped) -->
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <PathIcon Grid.Column="0" Data="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" Width="16" Height="16" Foreground="#7C4DFF" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" Text="{Binding StatusMessage}" VerticalAlignment="Center" Foreground="#DDDDDD" TextTrimming="CharacterEllipsis" Margin="0,0,8,0"/>
                                <Button Grid.Column="2" Content="Unsubscribe" Command="{Binding UnsubscribeCommand}" IsVisible="{Binding IsSubscribedToAny}"
                                        Background="#30FF0000" Foreground="#FF5555" FontSize="12" Padding="8,4" CornerRadius="4" VerticalAlignment="Center"/>
                            </Grid>

                            <!-- Artifact Selection -->
                            <StackPanel Spacing="8" IsVisible="{Binding IsSubscribedToAny}">
                                <TextBlock Text="Select Version" FontSize="12" Foreground="#AAAAAA"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <ComboBox Grid.Column="0" ItemsSource="{Binding AvailableVersions}" SelectedItem="{Binding SelectedVersion}"
                                              HorizontalAlignment="Stretch" PlaceholderText="{Binding VersionPlaceholderText}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel>
                                                    <TextBlock Text="{Binding DisplayVersion}" FontWeight="Bold"/>
                                                    <TextBlock Text="{Binding CreatedAt, StringFormat='{}{0:g}'}" FontSize="10" Opacity="0.7"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <ProgressBar Grid.Column="1" IsIndeterminate="True" IsVisible="{Binding IsLoadingVersions}" Width="20" Height="20" Margin="8,0,0,0"/>
                                </Grid>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </TabItem>

            <TabItem Header="Browse Builds">
                <Grid RowDefinitions="Auto,*">
                    <ScrollViewer Grid.Row="1">
                        <StackPanel Spacing="16">
                            <!-- Pull Requests -->
                            <Expander Header="Open Pull Requests" IsExpanded="True">
                                <ItemsControl ItemsSource="{Binding AvailablePullRequests}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#10FFFFFF" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="{Binding Title}" FontWeight="Medium" TextTrimming="CharacterEllipsis"/>
                                                        <StackPanel Orientation="Horizontal" Spacing="6" Opacity="0.6">
                                                            <TextBlock Text="{Binding Author, StringFormat='by {0}'}" FontSize="12"/>
                                                            <TextBlock Text="â€¢" FontSize="12"/>
                                                            <TextBlock Text="{Binding BranchName}" FontSize="12"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                    <Button Grid.Column="1"
                                                            Command="{Binding #Root.((vm:UpdateNotificationViewModel)DataContext).SubscribeToPrCommand}"
                                                            CommandParameter="{Binding Number}"
                                                            Classes="SmallAction SubscribeState">
                                                        <Button.Tag>
                                                            <MultiBinding Converter="{StaticResource IsSubscribedConverter}">
                                                                <Binding Path="." />
                                                                <Binding Path="#Root.((vm:UpdateNotificationViewModel)DataContext).SubscribedPr" />
                                                                <Binding Path="#Root.((vm:UpdateNotificationViewModel)DataContext).SubscribedBranch" />
                                                            </MultiBinding>
                                                        </Button.Tag>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Expander>

                            <!-- Branches -->
                            <Expander Header="Branches">
                                <ItemsControl ItemsSource="{Binding AvailableBranches}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#10FFFFFF" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <TextBlock Text="{Binding}" VerticalAlignment="Center" FontWeight="Medium"/>
                                                    <Button Grid.Column="1"
                                                            Command="{Binding #Root.((vm:UpdateNotificationViewModel)DataContext).SubscribeToBranchCommand}"
                                                            CommandParameter="{Binding}"
                                                            Classes="SmallAction SubscribeState">
                                                        <Button.Tag>
                                                            <MultiBinding Converter="{StaticResource IsSubscribedConverter}">
                                                                <Binding Path="." />
                                                                <Binding Path="#Root.((vm:UpdateNotificationViewModel)DataContext).SubscribedPr" />
                                                                <Binding Path="#Root.((vm:UpdateNotificationViewModel)DataContext).SubscribedBranch" />
                                                            </MultiBinding>
                                                        </Button.Tag>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Expander>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Footer Actions -->
        <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" Margin="0,16,0,0">
            <!-- Global Refresh Button -->
            <Button Grid.Column="0" Command="{Binding ManualRefreshCommand}" Content="Check for Updates"
                    Background="Transparent" Foreground="#AAAAAA" FontSize="14" Cursor="Hand"
                    ToolTip.Tip="Manually check for updates and restore dismissed notifications"/>

            <!-- Detailed Progress Display -->
            <StackPanel Grid.Column="1" IsVisible="{Binding IsInstalling}" VerticalAlignment="Center" Margin="16,0">
                <ProgressBar Value="{Binding DownloadProgress}" Height="4" Background="#33FFFFFF" Foreground="{DynamicResource SystemAccentColor}"/>
                <TextBlock Text="{Binding StatusMessage}" FontSize="12" Foreground="#AAAAAA" Margin="0,4,0,0" TextAlignment="Center"/>
            </StackPanel>

            <Button Grid.Column="2" Command="{Binding InstallUpdateCommand}" IsEnabled="{Binding CanDownloadUpdate}"
                    Background="{DynamicResource SystemAccentColor}" Foreground="White"
                    Padding="24,10" CornerRadius="20" FontWeight="Bold" FontSize="14">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <PathIcon Data="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" Width="16" Height="16" Foreground="White"/>
                    <TextBlock Text="{Binding InstallButtonText}"/>
                </StackPanel>
             </Button>
        </Grid>
    </Grid>
</UserControl>
