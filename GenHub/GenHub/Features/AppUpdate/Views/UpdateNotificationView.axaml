<UserControl xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:GenHub.Features.AppUpdate.ViewModels"
    x:Class="GenHub.Features.AppUpdate.Views.UpdateNotificationView"
    x:DataType="vm:UpdateNotificationViewModel">

    <Grid RowDefinitions="Auto,*,Auto" Margin="20,12,20,12">

        <!-- Status section with refresh button -->
        <Border Grid.Row="0"
            Background="#2D2D30"
            CornerRadius="8"
            Padding="12,10"
            Margin="0,0,0,12">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Border Grid.Column="0" Background="#7B1FA2" CornerRadius="6" Width="28" Height="28" VerticalAlignment="Center" Margin="0,0,10,0">
                    <Viewbox Width="16" Height="16">
                        <Path Data="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"
                            Fill="White" Stretch="Uniform" />
                    </Viewbox>
                </Border>
                <TextBlock Grid.Column="1" Text="{Binding StatusMessage, FallbackValue=Ready}" Foreground="White" FontSize="14" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding StatusMessage}" />
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">

                    <Button Command="{Binding CheckForUpdatesCommand}" IsEnabled="{Binding IsCheckButtonEnabled}" Background="#7B1FA2" Foreground="White" Padding="8" CornerRadius="6" BorderThickness="0" Cursor="Hand" ToolTip.Tip="Check For Updates">
                        <Viewbox Width="16" Height="16">
                            <Path Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" Fill="White" Stretch="Uniform" />
                        </Viewbox>
                        <Button.Styles>
                            <Style Selector="Button:pointerover"><Setter Property="Background" Value="#9C27B0" /></Style>
                            <Style Selector="Button:pressed"><Setter Property="Background" Value="#6A1B9A" /></Style>
                        </Button.Styles>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <ScrollViewer Grid.Row="1" Margin="0,0,0,4" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Update available section -->
                <Border Background="#1A7B1FA2"
                    CornerRadius="8"
                    Padding="24"
                    Margin="0,0,0,16"
                    IsVisible="{Binding IsUpdateAvailable}">
                    <StackPanel Spacing="16">
                <Grid ColumnDefinitions="Auto,*">
                    <Border Grid.Column="0"
                        Background="#3399FF"
                        CornerRadius="8"
                        Width="48" Height="48"
                        Margin="0,0,16,0">
                        <Viewbox Width="24" Height="24">
                            <Path Data="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"
                                Fill="White" Stretch="Uniform" />
                        </Viewbox>
                    </Border>

                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="Update Available!" FontWeight="Bold" FontSize="20" Foreground="White" Margin="0,0,0,4" />
                        <TextBlock Foreground="#B3FFFFFF" FontSize="14">
                            <Run Text="Version" />
                            <Run Text="{Binding DisplayLatestVersion}" FontWeight="SemiBold" />
                            <Run Text="is ready to install" />
                        </TextBlock>
                    </StackPanel>
                </Grid>

                <Border Background="#3D3D40" CornerRadius="6" Padding="16">
                    <StackPanel Spacing="8">
                        <TextBlock Text="What's new:" FontWeight="SemiBold" Foreground="White" FontSize="14" />
                        <TextBlock Text="This update includes bug fixes, performance improvements, and new features."
                                   Foreground="#B3FFFFFF"
                                   FontSize="13"
                                   TextWrapping="Wrap" />
                        <Button Command="{Binding ViewReleaseNotesCommand}"
                                Content="View Release Notes"
                                Background="Transparent"
                                Foreground="#3399FF"
                                BorderThickness="0"
                                Padding="0,8,0,0"
                                HorizontalAlignment="Left"
                                Cursor="Hand">
                            <Button.Styles>
                                <Style Selector="Button:pointerover">
                                    <Setter Property="Foreground" Value="#4DB3FF" />
                                </Style>
                            </Button.Styles>
                        </Button>
                    </StackPanel>
                </Border>

                <!-- Installation progress -->
                <Border Background="#3D3D40"
                        CornerRadius="6"
                        Padding="16"
                        IsVisible="{Binding IsInstalling}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="{Binding InstallationProgress.Status}" Foreground="White" FontSize="14" />
                        <ProgressBar Value="{Binding InstallationProgress.PercentComplete}"
                                     Maximum="100"
                                     Height="8"
                                     Foreground="#7B1FA2"
                                     Background="#505050"
                                     CornerRadius="4" />
                        <TextBlock Foreground="#90FFFFFF" FontSize="12">
                            <Run Text="{Binding InstallationProgress.PercentComplete, StringFormat={}{0:F0}}" />
                            <Run Text="% complete" />
                        </TextBlock>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>

                <!-- Error section -->
                <Border Background="#1AFF4444"
                    BorderBrush="#FF4444"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16"
                    Margin="0,0,0,16"
                    IsVisible="{Binding HasError}">
            <Grid ColumnDefinitions="Auto,*">
                <Border Grid.Column="0" Background="#FF4444" CornerRadius="6" Width="28" Height="28" Margin="0,0,12,0" VerticalAlignment="Top">
                    <Viewbox Width="16" Height="16">
                        <Path Data="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"
                            Fill="White" Stretch="Uniform" />
                    </Viewbox>
                </Border>
                <TextBlock Grid.Column="1"
                           Text="{Binding ErrorMessage}"
                           Foreground="#FFB3B3"
                           TextWrapping="Wrap"
                           VerticalAlignment="Center" />
            </Grid>
        </Border>

                <!-- PR Merged Warning -->
                <Border Background="#1AFFAA00"
                    BorderBrush="#FFAA00"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16"
                    Margin="0,0,0,8"
                    IsVisible="{Binding ShowPrMergedWarning}">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <Border Background="#FFAA00" CornerRadius="6" Width="28" Height="28">
                    <Viewbox Width="16" Height="16">
                        <Path Data="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"
                            Fill="White" Stretch="Uniform" />
                    </Viewbox>
                </Border>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Subscribed PR Merged" FontWeight="SemiBold" Foreground="#FFCC00" />
                    <TextBlock Text="Select a new PR or switch to MAIN branch" Foreground="#B3FFFFFF" FontSize="12" />
                </StackPanel>
                <Button Command="{Binding UnsubscribeCommand}"
                        Content="Switch to MAIN"
                        Background="#25FFFFFF"
                        Foreground="White"
                        Padding="12,6"
                        CornerRadius="4"
                        BorderThickness="0"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Right" />
            </StackPanel>
        </Border>

                <!-- Open Pull Requests section -->
                <Border Background="#2D2D30"
                    CornerRadius="8"
                    Padding="16"
                    Margin="0,0,0,8"
                    IsVisible="{Binding HasPat}">
                    <StackPanel Spacing="12">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <Viewbox Width="16" Height="16" VerticalAlignment="Center">
                                    <Path Data="M18,16V13C18,11.34 16.66,10 15,10H6V12H15C15.55,12 16,12.45 16,13V16H13L17,20L21,16H18M6,8V11H4V8C4,7.45 4.45,7 5,7H11V5H5C3.34,5 2,6.34 2,8V16H5L1,20L-3,16H0V8H6Z"
                                        Fill="#FF9800" Stretch="Uniform" />
                                </Viewbox>
                                <TextBlock Text="Open Pull Requests" FontWeight="SemiBold" Foreground="White" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding AvailablePullRequests.Count, StringFormat='({0})'}" Foreground="#90FFFFFF" FontSize="12" VerticalAlignment="Center" />
                            </StackPanel>
                            <Button Grid.Column="1"
                                Command="{Binding LoadPullRequestsCommand}"
                                Content="↻ Refresh"
                                Background="Transparent"
                                Foreground="#3399FF"
                                BorderThickness="0"
                                Padding="8,4"
                                VerticalAlignment="Center" />
                        </Grid>

                        <!-- Loading indicator -->
                        <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding IsLoadingPullRequests}">
                            <ProgressBar IsIndeterminate="True" Width="100" Height="4" Foreground="#FF9800" />
                            <TextBlock Text="Loading PRs..." Foreground="#90FFFFFF" FontSize="12" />
                        </StackPanel>

                        <!-- PR List -->
                        <ItemsControl ItemsSource="{Binding AvailablePullRequests}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#3D3D40" CornerRadius="4" Padding="10" Margin="0,2">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="{Binding Title}" Foreground="White" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" Margin="0,0,8,4" />
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <Border Background="#3399FF" CornerRadius="3" Padding="6,2">
                                                        <TextBlock Text="{Binding Number, StringFormat='#{0}'}" Foreground="White" FontSize="11" FontWeight="Bold" />
                                                    </Border>
                                                    <TextBlock Text="{Binding Author, StringFormat='by {0}'}" Foreground="#90FFFFFF" FontSize="11" VerticalAlignment="Center" />
                                                    <TextBlock Text="{Binding BranchName, StringFormat='({0})'}" Foreground="#90FFFFFF" FontSize="11" VerticalAlignment="Center" FontStyle="Italic" />
                                                </StackPanel>
                                            </StackPanel>
                                            <Button Grid.Column="1"
                                                Command="{Binding $parent[ItemsControl].((vm:UpdateNotificationViewModel)DataContext).SubscribeToPrCommand}"
                                                CommandParameter="{Binding Number}"
                                                Content="Subscribe"
                                                Background="#3399FF"
                                                Foreground="White"
                                                Padding="10,6"
                                                CornerRadius="4"
                                                BorderThickness="0"
                                                FontSize="11"
                                                FontWeight="Medium"
                                                Cursor="Hand"
                                                VerticalAlignment="Center">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="#4DB3FF" />
                                                    </Style>
                                                </Button.Styles>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Development Branches section -->
                <Border Background="#2D2D30"
                    CornerRadius="8"
                    Padding="16"
                    Margin="0,0,0,8"
                    IsVisible="{Binding HasPat}">
                    <StackPanel Spacing="12">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <Viewbox Width="16" Height="16" VerticalAlignment="Center">
                                    <Path Data="M19,15V13A3,3 0 0,0 16,10H14.82C14.4,8.84 13.3,8 12,8C10.7,8 9.6,8.84 9.18,10H8A3,3 0 0,0 5,13V15A3,3 0 0,0 2,18V20A1,1 0 0,0 3,21H21A1,1 0 0,0 22,20V18A3,3 0 0,0 19,15M17,15V18H19V20H5V18H7V15A1,1 0 0,1 8,14H9.18C9.6,15.16 10.7,16 12,16C13.3,16 14.4,15.16 14.82,14H16A1,1 0 0,1 17,15Z"
                                        Fill="#3399FF" Stretch="Uniform" />
                                </Viewbox>
                                <TextBlock Text="Development Branches" FontWeight="SemiBold" Foreground="White" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding AvailableBranches.Count, StringFormat='({0})'}" Foreground="#90FFFFFF" FontSize="12" VerticalAlignment="Center" />
                            </StackPanel>
                            <Button Grid.Column="1"
                                Command="{Binding LoadBranchesCommand}"
                                Content="↻ Refresh"
                                Background="Transparent"
                                Foreground="#3399FF"
                                BorderThickness="0"
                                Padding="8,4"
                                VerticalAlignment="Center" />
                        </Grid>

                        <!-- Loading indicator -->
                        <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding IsLoadingBranches}">
                            <ProgressBar IsIndeterminate="True" Width="100" Height="4" Foreground="#3399FF" />
                            <TextBlock Text="Loading Branches..." Foreground="#90FFFFFF" FontSize="12" />
                        </StackPanel>

                        <!-- Branch List -->
                        <ItemsControl ItemsSource="{Binding AvailableBranches}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#3D3D40" CornerRadius="4" Padding="10" Margin="0,2">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBlock Grid.Column="0" Text="{Binding}" Foreground="White" VerticalAlignment="Center" />
                                            <Button Grid.Column="1"
                                                Command="{Binding $parent[ItemsControl].((vm:UpdateNotificationViewModel)DataContext).SubscribeToBranchCommand}"
                                                CommandParameter="{Binding}"
                                                Content="Subscribe"
                                                Background="#3399FF"
                                                Foreground="White"
                                                Padding="10,6"
                                                CornerRadius="4"
                                                BorderThickness="0"
                                                FontSize="11"
                                                FontWeight="Medium"
                                                Cursor="Hand"
                                                VerticalAlignment="Center">
                                                <Button.Styles>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="#4DB3FF" />
                                                    </Style>
                                                </Button.Styles>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Currently Subscribed section (Unified for PR and Branch) -->
                <Border Background="#1A67B26F" 
                        CornerRadius="8" 
                        Padding="16" 
                        Margin="0,0,0,8"
                        IsVisible="{Binding IsSubscribedToAny}">
                    <StackPanel Spacing="12">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Text="Currently Subscribed" Foreground="#67B26F" FontWeight="SemiBold" FontSize="14" />
                                
                                <!-- PR Info -->
                                <StackPanel IsVisible="{Binding SubscribedPr, Converter={x:Static ObjectConverters.IsNotNull}}" Spacing="2">
                                    <Grid ColumnDefinitions="Auto,*">
                                        <TextBlock Grid.Column="0" Text="{Binding SubscribedPr.Number, StringFormat='PR #{0}'}" Foreground="White" FontWeight="SemiBold" Margin="0,0,8,0" />
                                        <TextBlock Grid.Column="1" Text="{Binding SubscribedPr.Title}" Foreground="#B3FFFFFF" TextTrimming="CharacterEllipsis" />
                                    </Grid>
                                    <TextBlock Text="{Binding SubscribedPr.LatestArtifact.DisplayVersion, StringFormat='Latest: {0}'}" Foreground="#90FFFFFF" FontSize="12" />
                                </StackPanel>

                                <!-- Branch Info -->
                                <StackPanel IsVisible="{Binding SubscribedBranch, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" Spacing="2">
                                    <TextBlock Text="{Binding SubscribedBranch, StringFormat='Branch: {0}'}" Foreground="White" FontWeight="SemiBold" />
                                    <TextBlock Text="Tracking latest artifacts from GitHub Actions" Foreground="#90FFFFFF" FontSize="12" />
                                </StackPanel>
                            </StackPanel>

                            <Button Grid.Column="1"
                                Command="{Binding UnsubscribeCommand}"
                                Content="Unsubscribe"
                                Background="Transparent"
                                Foreground="#FF6666"
                                BorderThickness="0"
                                Padding="8,4"
                                VerticalAlignment="Top" />
                        </Grid>

                        <Separator Background="#20FFFFFF" Height="1" Margin="0,4" />

                        <!-- Action Buttons based on subscription type -->
                        
                        <!-- Install PR Build Button -->
                        <Button Command="{Binding InstallPrArtifactCommand}"
                                IsVisible="{Binding SubscribedPr, Converter={x:Static ObjectConverters.IsNotNull}}"
                                IsEnabled="{Binding CanInstallPrArtifact}"
                                HorizontalAlignment="Stretch"
                                Background="#67B26F"
                                Foreground="White"
                                Padding="12,10"
                                CornerRadius="6">
                            <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                                <PathIcon Data="M13 3L4 14h7l-1 7 9-11h-7l1-7z" Width="16" Height="16" Foreground="White" />
                                <TextBlock Text="Install Latest PR Build" FontWeight="SemiBold" />
                            </StackPanel>
                        </Button>

                        <!-- Install Branch Build Button -->
                        <Button Command="{Binding InstallBranchArtifactCommand}"
                                IsVisible="{Binding SubscribedBranch, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                IsEnabled="{Binding CanInstallBranchArtifact}"
                                HorizontalAlignment="Stretch"
                                Background="#67B26F"
                                Foreground="White"
                                Padding="12,10"
                                CornerRadius="6">
                            <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                                <PathIcon Data="M13 3L4 14h7l-1 7 9-11h-7l1-7z" Width="16" Height="16" Foreground="White" />
                                <TextBlock Text="Install Latest Branch Build" FontWeight="SemiBold" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Action buttons -->
        <Grid Grid.Row="2" ColumnDefinitions="*,Auto,Auto" Margin="0,4,0,0">
            <Button Grid.Column="1"
                Command="{Binding DismissCommand}"
                Content="Dismiss"
                Background="#404040"
                Foreground="White"
                Padding="20,12"
                Margin="0,0,12,0"
                CornerRadius="8"
                BorderThickness="0">
                <Button.Styles>
                    <Style Selector="Button:pointerover">
                        <Setter Property="Background" Value="#505050" />
                    </Style>
                </Button.Styles>
            </Button>

            <Button Grid.Column="2"
                Command="{Binding InstallUpdateCommand}"
                IsEnabled="{Binding CanDownloadUpdate}"
                Background="#7B1FA2"
                Foreground="White"
                Padding="20,12"
                CornerRadius="8"
                BorderThickness="0">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Viewbox Width="16" Height="16" IsVisible="{Binding !IsInstalling}">
                        <Path Data="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"
                            Fill="White" Stretch="Uniform" />
                    </Viewbox>
                    <TextBlock Text="{Binding InstallButtonText}" VerticalAlignment="Center" FontWeight="Medium" />
                </StackPanel>
                <Button.Styles>
                    <Style Selector="Button:pointerover">
                        <Setter Property="Background" Value="#9C27B0" />
                    </Style>
                    <Style Selector="Button:pressed">
                        <Setter Property="Background" Value="#6A1B9A" />
                    </Style>
                    <Style Selector="Button:disabled">
                        <Setter Property="Background" Value="#505050" />
                        <Setter Property="Foreground" Value="#60FFFFFF" />
                    </Style>
                </Button.Styles>
            </Button>
        </Grid>
    </Grid>
</UserControl>
