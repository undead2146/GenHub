<UserControl xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="clr-namespace:GenHub.Features.GameProfiles.ViewModels"
    xmlns:conv="clr-namespace:GenHub.Infrastructure.Converters"
    x:Class="GenHub.Features.GameProfiles.Views.GameProfileCardView"
    x:DataType="vm:GameProfileItemViewModel">
    
    <UserControl.Resources>
        <conv:ContrastTextColorConverter x:Key="ContrastTextColorConverter" />
        <conv:ProfileCoverConverter x:Key="ProfileCoverConverter" />
        <conv:StringToImageConverter x:Key="StringToImageConverter" />
        <conv:NullSafePropertyConverter x:Key="NullSafeConverter"/>
        <conv:BoolToValueConverter x:Key="NotConverter" TrueValue="False" FalseValue="True" />
        <conv:ProfileColorToOpacityConverter x:Key="ProfileColorToOpacityConverter" />
        <conv:ColorBrightnessConverter x:Key="ColorBrightnessConverter" />
        <conv:ColorToBrushConverter x:Key="ColorToBrushConverter" />
        <conv:StringToBoolConverter x:Key="StringToBoolConverter" />
        <conv:ContentTypeDisplayConverter x:Key="ContentTypeDisplayConverter" />
        <conv:GameTypeDisplayConverter x:Key="GameTypeDisplayConverter" />
        <conv:GameTypeShortDisplayConverter x:Key="GameTypeShortDisplayConverter" />
        <conv:GameTypeToIconConverter x:Key="GameTypeToIconConverter" />
        <conv:InstallationTypeDisplayConverter x:Key="InstallationTypeDisplayConverter" />
    </UserControl.Resources>    <UserControl.Styles>
        <!-- Profile card styles -->
        <Style Selector="Border.profile-card">
            <Setter Property="Background" Value="{Binding ColorValue, Converter={StaticResource ColorToBrushConverter}, FallbackValue=#2A2A2A}" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Margin" Value="0 0 16 16" />
            <Setter Property="MinWidth" Value="280" />
            <Setter Property="MaxWidth" Value="400" />
            <!-- Width will be determined by available space in the layout -->
            <Setter Property="MinHeight" Value="220" />
            <Setter Property="MaxHeight" Value="320" />
            <Setter Property="BoxShadow" Value="0 4 12 0 #40000000" />
            <Setter Property="ClipToBounds" Value="True" />
            <Setter Property="Transitions">
                <Setter.Value>
                    <Transitions>
                        <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" />
                        <BoxShadowsTransition Property="BoxShadow" Duration="0:0:0.2" />
                    </Transitions>
                </Setter.Value>
            </Setter>
        </Style>
        
        <Style Selector="Border.profile-card:pointerover">
            <Setter Property="BoxShadow" Value="0 8 20 0 #50000000" />
            <Setter Property="RenderTransform" Value="translate(0px, -4px) scale(1.02)" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <!-- Enhanced badge style for profile cards -->
        <Style Selector="Border.profile-badge">
            <Setter Property="Background" Value="#70FFFFFF" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="8,3" />
            <Setter Property="Margin" Value="0,0,6,4" />
            <Setter Property="BoxShadow" Value="0 2 4 0 #30000000" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BorderBrush" Value="#30FFFFFF" />
        </Style>

        <Style Selector="TextBlock.badge-text">
            <Setter Property="FontSize" Value="10" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Foreground" Value="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}" />
            <Setter Property="LetterSpacing" Value="0.5" />
        </Style>

        <!-- Source badge styles -->
        <Style Selector="Border.source-badge">
            <Setter Property="Background" Value="#40000000" />
            <Setter Property="CornerRadius" Value="3" />
            <Setter Property="Padding" Value="5,1" />
            <Setter Property="Margin" Value="0,4,5,0" />
        </Style>

        <!-- Launch button - dynamic colors based on profile theme -->
        <Style Selector="Button.profile-launch-button">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Background" Value="#50FFFFFF" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Height" Value="40" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="FontSize" Value="15" />
        </Style>

        <Style Selector="Button.profile-launch-button:pointerover">
            <Setter Property="BorderThickness" Value="1.5" />
        </Style>

        <Style Selector="Button.profile-launch-button:pressed">
            <Setter Property="Opacity" Value="0.8" />
        </Style>

        <!-- Action button - dynamic colors based on profile theme -->
        <Style Selector="Button.action-button">
            <Setter Property="MinWidth" Value="80" />
            <Setter Property="Height" Value="40" />
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="Padding" Value="12,0" />
            <Setter Property="Background" Value="#50FFFFFF" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
        </Style>
        
        <Style Selector="Button.action-button:pointerover">
            <Setter Property="BorderThickness" Value="1.5" />
        </Style>

        <Style Selector="Button.action-button:pressed">
            <Setter Property="Opacity" Value="0.8" />
        </Style>

        <!-- Prepare button - dynamic colors based on profile theme -->
        <Style Selector="Button.prepare-button">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Background" Value="#50FFFFFF" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="MinWidth" Value="100" />
            <Setter Property="Height" Value="40" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="FontSize" Value="12" />
        </Style>

        <Style Selector="Button.prepare-button:pointerover">
            <Setter Property="BorderThickness" Value="1.5" />
        </Style>

        <Style Selector="Button.prepare-button:pressed">
            <Setter Property="Opacity" Value="0.8" />
        </Style>

        <!-- Delete button specific styling -->
        <Style Selector="Button.delete-button">
            <Setter Property="Background" Value="#EF4444" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="#B91C1C" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Width" Value="32" />
            <Setter Property="Height" Value="32" />
            <Setter Property="CornerRadius" Value="16" />
            <Setter Property="Padding" Value="0" />
        </Style>
        
        <Style Selector="Button.delete-button:pointerover">
            <Setter Property="Background" Value="#B91C1C" />
        </Style>
    </UserControl.Styles>
    <Border Classes="profile-card" Tag="profileCard">
        <Grid RowDefinitions="Auto,*,Auto">
            <!-- Cover Image / Background -->
            <Image Grid.RowSpan="3"
                Source="{Binding CoverImagePath, Converter={StaticResource StringToImageConverter}}" />

            <!-- Top section with icon and title - fixed height -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="16,16,16,0">
                <Border Grid.Column="0" Width="48" Height="48" Background="#30FFFFFF" CornerRadius="24" VerticalAlignment="Top">
                    <Image Source="{Binding IconPath, Converter={StaticResource StringToImageConverter}}" Width="40" Height="40" />
                </Border>
                <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Top" Spacing="2">
                    <TextBlock 
                        Text="{Binding Name, FallbackValue='Unknown Profile'}" 
                        Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}" 
                        FontWeight="SemiBold" 
                        TextWrapping="Wrap" 
                        MaxLines="2" 
                        TextTrimming="CharacterEllipsis" 
                        FontSize="18" />
                    <TextBlock 
                        Text="{Binding Description, FallbackValue='Game Profile'}" 
                        Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}, ConverterParameter=0.8}" 
                        FontSize="12" 
                        TextWrapping="Wrap" 
                        MaxLines="2" 
                        TextTrimming="CharacterEllipsis" />
                </StackPanel>
            </Grid>

            <!-- Middle section with metadata badges -->
            <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                <StackPanel Spacing="6" Margin="16,0,16,0">
                    <!-- Game Version, Publisher, Content Type badges (top priority) -->
                    <WrapPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <!-- Game Version badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding GameVersion, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            HorizontalAlignment="Left">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                                TextTrimming="CharacterEllipsis"
                                MaxLines="1">
                                <Run Text="v" />
                                <Run Text="{Binding GameVersion, FallbackValue=''}" />
                            </TextBlock>
                        </Border>

                        <!-- Publisher/Platform badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding Publisher, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            HorizontalAlignment="Left">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                                TextTrimming="CharacterEllipsis"
                                MaxLines="1">
                                <Run Text="{Binding Publisher, FallbackValue=''}" />
                            </TextBlock>
                        </Border>
                    </WrapPanel>

                    <!-- Source type badges -->
                    <WrapPanel Orientation="Horizontal" Margin="0,0,0,6"
                        IsVisible="{Binding VersionId, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <!-- Source type badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding SourceTypeName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            HorizontalAlignment="Left">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                                TextTrimming="CharacterEllipsis"
                                MaxLines="1">
                                <Run Text="{Binding SourceTypeName, FallbackValue=''}" />
                            </TextBlock>
                        </Border>

                        <!-- Installation Source badge -->
                        <Border Classes="source-badge" Background="#40FFFFFF">
                            <TextBlock Classes="badge-text"
                                FontSize="10"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="{Binding SourceTypeName, FallbackValue='Unknown'}" />
                            </TextBlock>
                        </Border>
                    </WrapPanel>

                    <!-- GitHub workflow info badges -->
                    <WrapPanel Orientation="Horizontal" Margin="0,0,0,4"
                        IsVisible="{Binding HasWorkflowInfo, FallbackValue=False}">
                        <!-- Workflow badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding HasWorkflowInfo}">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="WORKFLOW #" />
                                <Run Text="{Binding WorkflowNumber, FallbackValue=''}" />
                            </TextBlock>
                        </Border>

                        <!-- PR badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding HasWorkflowInfo}">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="PR #" />
                                <Run Text="{Binding PullRequestNumber, FallbackValue=''}" />
                            </TextBlock>
                        </Border>

                        <!-- Commit badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding CommitSha, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="COMMIT " />
                                <Run Text="{Binding ShortCommitSha, FallbackValue=''}" />
                            </TextBlock>
                        </Border>
                    </WrapPanel>

                    <!-- Build info badges -->
                    <WrapPanel Orientation="Horizontal" Margin="0,0,0,4"
                        IsVisible="{Binding HasBuildInfo}">
                        <!-- Compiler badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding HasBuildInfo}">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="{Binding DisplayCompiler, FallbackValue=''}" />
                            </TextBlock>
                        </Border>

                        <!-- Configuration badge -->
                        <Border Classes="profile-badge"
                            IsVisible="{Binding HasBuildInfo}">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="{Binding DisplayConfiguration, FallbackValue=''}" />
                            </TextBlock>
                        </Border>

                        <!-- T Flag badge -->
                        <Border Classes="profile-badge"
                            IsVisible="False">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="T FLAG" />
                            </TextBlock>
                        </Border>

                        <!-- E Flag badge -->
                        <Border Classes="profile-badge"
                            IsVisible="False">
                            <TextBlock Classes="badge-text"
                                Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                                <Run Text="E FLAG" />
                            </TextBlock>
                        </Border>
                    </WrapPanel>

                    <!-- BuildPreset badge -->
                    <Border Classes="profile-badge"
                        IsVisible="{Binding BuildPreset, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                        HorizontalAlignment="Left" Margin="0,0,0,4">
                        <TextBlock Classes="badge-text"
                            TextWrapping="Wrap"
                            Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                            <Run Text="{Binding BuildPreset, FallbackValue=''}" />
                        </TextBlock>
                    </Border>

                    <!-- Admin badge - when RunAsAdmin is true -->
                    <Border Classes="profile-badge"
                        IsVisible="{Binding RunAsAdmin}"
                        HorizontalAlignment="Left" Margin="0,0,0,4">
                        <TextBlock Classes="badge-text"
                            Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}">
                            <Run Text="ADMIN" />
                        </TextBlock>
                    </Border>

                    <!-- Build info badge -->
                    <Border Classes="profile-badge"
                        IsVisible="{Binding HasBuildInfo}"
                        HorizontalAlignment="Left">
                        <TextBlock Classes="badge-text"
                            Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                            TextTrimming="CharacterEllipsis"
                            MaxLines="1">
                            <Run Text="BUILD: " />
                            <Run Text="{Binding BuildInfo, FallbackValue=''}" />
                        </TextBlock>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!-- Bottom section with launch & action buttons - fixed height -->
            <Grid Grid.Row="2" ColumnDefinitions="*,Auto" Margin="16,8,16,16" VerticalAlignment="Bottom">
                <!-- Launch button with glass effect - hidden when process is running -->
                <Button Grid.Column="0" 
                    Classes="profile-launch-button" 
                    Content="Launch" 
                    Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                    BorderBrush="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                    Command="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).LaunchProfileCommand}" 
                    CommandParameter="{Binding}" 
                    IsEnabled="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).IsPreparingWorkspace, Converter={StaticResource NotConverter}}"
                    IsVisible="{Binding CanLaunch}"
                    ToolTip.Tip="Launch this profile"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center"
                    Margin="0,0,8,0" />

                <!-- Action buttons container (centered group) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <!-- Prepare Workspace button - disabled when already prepared, running, or ANY workspace is being prepared -->
                    <Button Classes="prepare-button"
                        Content="{Binding WorkspaceStatus}"
                        Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                        BorderBrush="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                        Command="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).PrepareWorkspaceCommand}"
                        CommandParameter="{Binding}"
                        ToolTip.Tip="Prepare workspace for this profile"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center">
                        <Button.IsEnabled>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="IsWorkspacePrepared" Converter="{StaticResource NotConverter}" />
                                <Binding Path="$parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).IsPreparingWorkspace" Converter="{StaticResource NotConverter}" />
                            </MultiBinding>
                        </Button.IsEnabled>
                    </Button>

                    <!-- Stop button - only visible when process is running -->
                    <Button Classes="action-button"
                        Content="⏹"
                        Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                        BorderBrush="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                        Command="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).StopProfileCommand}"
                        CommandParameter="{Binding}"
                        IsVisible="{Binding IsProcessRunning}"
                        ToolTip.Tip="Stop this profile"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        FontSize="16" />

                    <!-- Edit button - disabled when process is running or workspace being prepared -->
                    <Button Classes="action-button" 
                        Name="EditButton"
                        Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                        BorderBrush="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                        Command="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).EditProfileCommand}"
                        CommandParameter="{Binding}"
                        ToolTip.Tip="Edit this profile"
                        IsVisible="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).IsEditMode}"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center">
                        <Button.IsEnabled>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="CanEdit" />
                                <Binding Path="$parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).IsPreparingWorkspace" Converter="{StaticResource NotConverter}" />
                            </MultiBinding>
                        </Button.IsEnabled>
                        <PathIcon Data="M20.71,4.04C21.1,3.65 21.1,3 20.71,2.63L18.37,0.29C18,-.1 17.35,-.1 16.96,0.29L15.12,2.12L18.87,5.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" 
                            Foreground="{Binding ColorValue, Converter={StaticResource ContrastTextColorConverter}}"
                            Width="14" Height="14" />
                    </Button>

                    <!-- Delete button (only visible in edit mode and when not running or preparing) -->
                    <Button Classes="delete-button"
                        Command="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).DeleteProfileCommand}"
                        CommandParameter="{Binding}"
                        IsVisible="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).IsEditMode}"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center">
                        <Button.IsEnabled>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="CanEdit" />
                                <Binding Path="$parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).IsPreparingWorkspace" Converter="{StaticResource NotConverter}" />
                            </MultiBinding>
                        </Button.IsEnabled>
                        <PathIcon Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" 
                            Foreground="White"
                            Width="16" Height="16" />
                    </Button>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</UserControl>
