<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:GenHub.Features.GameProfiles.ViewModels"
        xmlns:conv="clr-namespace:GenHub.Infrastructure.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
        x:Class="GenHub.Features.GameProfiles.Views.AddLocalContentWindow"
        x:DataType="vm:AddLocalContentViewModel"
        x:Name="RootWindow"
        Title="Add Local Content"
        Width="800" Height="600"
        WindowStartupLocation="CenterOwner"
        CanResize="True"
        SystemDecorations="Full"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="-1"
        TransparencyLevelHint="AcrylicBlur"
        Background="Transparent"
        DragDrop.AllowDrop="True">

    <Window.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <conv:InvertedBoolToVisibilityConverter x:Key="InvertedBoolToVisibilityConverter" />
        <conv:BoolToTextConverter x:Key="BoolToTextConverter" />
    </Window.Resources>

    <Panel>
        <!-- Acrylic Tint Layer -->
        <ExperimentalAcrylicBorder IsHitTestVisible="False">
            <ExperimentalAcrylicBorder.Material>
                <ExperimentalAcrylicMaterial
                    BackgroundSource="Digger"
                    TintColor="Black"
                    TintOpacity="0.85"
                    MaterialOpacity="0.65" />
            </ExperimentalAcrylicBorder.Material>
        </ExperimentalAcrylicBorder>

        <!-- Main Content Border -->
        <Border BorderBrush="#30FFFFFF" BorderThickness="1" CornerRadius="0">
            <Grid RowDefinitions="30,Auto,*,Auto" Margin="20,10,20,20">

                <!-- Custom Title Bar Drag Area -->
                <Grid Grid.Row="0" Background="Transparent" IsHitTestVisible="False">
                    <TextBlock Text="Add Local Content"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Foreground="#80FFFFFF"
                               FontSize="12"
                               IsHitTestVisible="False"/>
                </Grid>

                <!-- Header Area -->
                <StackPanel Grid.Row="1" Margin="0,10,0,25" Spacing="5">
                    <TextBlock Text="Import Content" FontSize="28" FontWeight="Light" Foreground="White" />
                    <TextBlock Text="Drag and drop archives or folders, or browse below." FontSize="14" Foreground="#AAAAAA" />
                </StackPanel>

                <!-- Main Content Area -->
                <Grid Grid.Row="2" ColumnDefinitions="300,*" Margin="0,0,0,20">

                    <!-- LEFT COLUMN: Form -->
                    <StackPanel Grid.Column="0" Spacing="20" Margin="0,0,25,0">

                        <!-- Content Name -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="NAME" Classes="label"/>
                            <TextBox Text="{Binding ContentName}" Watermark="e.g. My Awesome Mod" Classes="glass"/>
                        </StackPanel>

                            <!-- Content Type -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="TYPE" Classes="label"/>
                            <ComboBox ItemsSource="{Binding AllowedContentTypes}"
                                      SelectedItem="{Binding SelectedContentType}"
                                      HorizontalAlignment="Stretch"
                                      Classes="glass">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={x:Static conv:ContentTypeDisplayConverter.Instance}}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                         <!-- Target Game -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="TARGET GAME" Classes="label"/>
                            <ComboBox ItemsSource="{Binding AvailableGameTypes}"
                                      SelectedItem="{Binding SelectedGameType}"
                                      HorizontalAlignment="Stretch"
                                      Classes="glass"/>
                        </StackPanel>

                        <!-- Source -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="SOURCE" Classes="label"/>
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Text="{Binding SourcePath}" IsReadOnly="True" Watermark="No content selected" Classes="glass" Margin="0,0,5,0"/>
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5">
                                    <Button Command="{Binding BrowseFolderCommand}" ToolTip.Tip="Browse Folder" Classes="icon-btn">
                                        <TextBlock Text="ðŸ“"/>
                                    </Button>
                                    <Button Command="{Binding BrowseFileCommand}" ToolTip.Tip="Browse Files" Classes="icon-btn">
                                        <TextBlock Text="ðŸ“¦"/>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </StackPanel>

                        <!-- Status Message -->
                         <Border Background="#20FFC107" BorderBrush="#40FFC107" BorderThickness="1" CornerRadius="4" Padding="10" IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                            <TextBlock Text="{Binding StatusMessage}" Foreground="#FFC107" TextWrapping="Wrap" FontSize="12"/>
                        </Border>

                    </StackPanel>

                    <!-- RIGHT COLUMN: Tree Preview -->
                    <Border Grid.Column="1" Background="#10FFFFFF" CornerRadius="8" BorderBrush="#20FFFFFF" BorderThickness="1">
                        <Grid RowDefinitions="Auto,*">
                            <Border Background="#10FFFFFF" CornerRadius="8,8,0,0" Padding="15,10">
                                <TextBlock Text="CONTENT PREVIEW" FontSize="11" FontWeight="Bold" Foreground="#80FFFFFF" LetterSpacing="1"/>
                            </Border>

                            <TreeView Grid.Row="1" ItemsSource="{Binding FileTree}" Background="Transparent" Foreground="#DDDDDD" Margin="5" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <TreeView.Styles>
                                    <Style Selector="TreeViewItem">
                                        <Setter Property="MinHeight" Value="24"/>
                                        <Setter Property="FontSize" Value="13"/>
                                    </Style>
                                </TreeView.Styles>
                                <TreeView.ItemTemplate>
                                    <TreeDataTemplate ItemsSource="{Binding Children}">
                                        <Grid ColumnDefinitions="*,Auto,Auto" Background="Transparent" Margin="0,0,10,0">
                                            <DockPanel Grid.Column="0" LastChildFill="True">
                                                <!-- Icon: exe gets special icon, otherwise file/folder -->
                                                <TextBlock DockPanel.Dock="Left"
                                                           Text="{Binding IsFile, Converter={StaticResource BoolToTextConverter}, ConverterParameter='ðŸ“„|ðŸ“'}"
                                                           Opacity="0.7"
                                                           Margin="0,0,8,0"/>
                                                <!-- Name with Truncation -->
                                                <TextBlock Text="{Binding Name}"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                           ToolTip.Tip="{Binding Name}">
                                                    <TextBlock.Foreground>
                                                        <MultiBinding>
                                                            <MultiBinding.Converter>
                                                                <conv:ExecutableHighlightConverter/>
                                                            </MultiBinding.Converter>
                                                            <Binding Path="IsExecutable"/>
                                                            <Binding Path="IsSelectedExecutable"/>
                                                        </MultiBinding>
                                                    </TextBlock.Foreground>
                                                </TextBlock>
                                            </DockPanel>

                                            <!-- Select as Executable button (only for .exe files when using Executable type) -->
                                            <!-- Visibility logic: Item is executable AND ViewModel.ShowExecutableSelection is true -->
                                            <Button Grid.Column="1"
                                                    Command="{Binding #RootWindow.((vm:AddLocalContentViewModel)DataContext).SelectExecutableCommand}"
                                                    CommandParameter="{Binding}"
                                                    Classes="icon-btn"
                                                    Padding="4,2"
                                                    Margin="5,0,0,0"
                                                    ToolTip.Tip="Select as main executable"
                                                    IsVisible="{Binding IsExecutable}">
                                                <!-- MultiBinding for IsVisible to combine IsExecutable and ShowExecutableSelection would be ideal,
                                                     but easier to just toggle IsVisible in style or code behavior.
                                                     Since ShowExecutableSelection is global, we can bind to ancestor. -->
                                                <Button.IsVisible>
                                                    <MultiBinding Converter="{x:Static conv:MultiBooleanAndConverter.Instance}">
                                                        <Binding Path="IsExecutable"/>
                                                        <Binding Path="#RootWindow.((vm:AddLocalContentViewModel)DataContext).ShowExecutableSelection"/>
                                                    </MultiBinding>
                                                </Button.IsVisible>
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <TextBlock Text="â–¶" FontSize="10"/>
                                                    <TextBlock Text="{Binding IsSelectedExecutable, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Selected|Select'}" FontSize="10"/>
                                                </StackPanel>
                                            </Button>

                                            <!-- DELETE BUTTON: Always visible for all items -->
                                            <Button Grid.Column="2"
                                                    Command="{Binding #RootWindow.((vm:AddLocalContentViewModel)DataContext).DeleteItemCommand}"
                                                    CommandParameter="{Binding}"
                                                    Classes="icon-btn"
                                                    Padding="4,2"
                                                    Margin="10,0,0,0"
                                                    ToolTip.Tip="Remove Item">
                                                <TextBlock Text="âœ•" FontSize="10"/>
                                            </Button>
                                        </Grid>
                                    </TreeDataTemplate>
                                </TreeView.ItemTemplate>
                            </TreeView>

                            <!-- Empty State Overlay -->
                            <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="10" IsVisible="{Binding !FileTree.Count}">
                                <TextBlock Text="No Content Loaded" Foreground="#40FFFFFF" FontSize="16" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding PreviewIdleText}" Foreground="#30FFFFFF" FontSize="12" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Footer Actions -->
                <Grid Grid.Row="3" ColumnDefinitions="Auto,*,Auto">
                    <Button Grid.Column="0" Content="Cancel" Command="{Binding CancelCommand}" Classes="ghost"/>

                    <Button Grid.Column="2" Command="{Binding AddContentCommand}" Classes="accent" IsEnabled="{Binding CanAdd}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="âœ“"/>
                            <TextBlock Text="ADD CONTENT"/>
                        </StackPanel>
                    </Button>
                </Grid>

            </Grid>
        </Border>

        <!-- Loading Overlay -->
        <Grid Background="#CC000000" IsVisible="{Binding IsBusy}">
             <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="15">
                 <ProgressBar IsIndeterminate="True" Width="200" Height="4" Foreground="#5E35B1"/>
                 <TextBlock Text="Processing..." Foreground="White" HorizontalAlignment="Center" FontSize="14" FontWeight="Light"/>
             </StackPanel>
        </Grid>

    </Panel>

    <Window.Styles>
        <Style Selector="TextBlock.label">
            <Setter Property="Foreground" Value="#80FFFFFF"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="LetterSpacing" Value="1"/>
        </Style>

        <Style Selector="TextBox.glass">
            <Setter Property="Background" Value="#10FFFFFF"/>
            <Setter Property="BorderBrush" Value="#20FFFFFF"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="8,6"/>
        </Style>
        <Style Selector="TextBox.glass:focus">
            <Setter Property="Background" Value="#15FFFFFF"/>
            <Setter Property="BorderBrush" Value="#40FFFFFF"/>
        </Style>

        <Style Selector="ComboBox.glass">
            <Setter Property="Background" Value="#10FFFFFF"/>
            <Setter Property="BorderBrush" Value="#20FFFFFF"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="8,6"/>
        </Style>

        <Style Selector="Button.icon-btn">
             <Setter Property="Background" Value="#10FFFFFF"/>
             <Setter Property="BorderBrush" Value="#20FFFFFF"/>
             <Setter Property="Padding" Value="10,6"/>
             <Setter Property="CornerRadius" Value="4"/>
             <Setter Property="Foreground" Value="White"/>
             <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.icon-btn:pointerover">
             <Setter Property="Background" Value="#20FFFFFF"/>
        </Style>

        <Style Selector="Button.accent">
            <Setter Property="Background" Value="#5E35B1"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="20,10"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.accent:pointerover">
            <Setter Property="Background" Value="#7E57C2"/>
        </Style>
        <Style Selector="Button.accent:disabled">
            <Setter Property="Background" Value="#20FFFFFF"/>
            <Setter Property="Foreground" Value="#50FFFFFF"/>
            <Setter Property="Cursor" Value="Arrow"/>
        </Style>

        <Style Selector="Button.ghost">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#AAAAAA"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.ghost:pointerover">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="#10FFFFFF"/>
        </Style>
    </Window.Styles>
</Window>
