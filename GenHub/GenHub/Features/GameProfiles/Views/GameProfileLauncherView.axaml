<UserControl xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:GenHub.Features.GameProfiles.ViewModels"
    xmlns:views="clr-namespace:GenHub.Features.GameProfiles.Views"
    xmlns:local="clr-namespace:GenHub.Features.GameProfiles.Views"
    xmlns:conv="clr-namespace:GenHub.Infrastructure.Converters"
    mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="550"
    x:Class="GenHub.Features.GameProfiles.Views.GameProfileLauncherView"
    x:Name="ProfileLauncher"
    x:DataType="vm:GameProfileLauncherViewModel">

    <UserControl.Resources>
        <conv:ContrastTextColorConverter x:Key="ContrastTextColorConverter" />
        <conv:ProfileCoverConverter x:Key="ProfileCoverConverter" />
        <conv:StringToImageConverter x:Key="StringToImageConverter" />

        <x:Double x:Key="ExpandedHeight">100.0</x:Double>
        <x:Double x:Key="CollapsedHeight">0.0</x:Double>
        <x:Double x:Key="FullOpacity">1.0</x:Double>
        <x:Double x:Key="ZeroOpacity">0.0</x:Double>

        <conv:BoolToValueConverter x:Key="HeaderMaxHeightConverter"
                                   TrueValue="{StaticResource ExpandedHeight}"
                                   FalseValue="{StaticResource CollapsedHeight}" />
        <conv:BoolToValueConverter x:Key="HeaderOpacityConverter"
                                   TrueValue="{StaticResource FullOpacity}"
                                   FalseValue="{StaticResource ZeroOpacity}" />

        <conv:BoolToValueConverter x:Key="BoolToVisibilityConverter"
            TrueValue="Visible"
            FalseValue="Collapsed" />

        <conv:BoolToColorConverter x:Key="EditModeToggleBackgroundConverter" TrueColor="#1E88E5" FalseColor="#333333" />
        <conv:BoolToValueConverter x:Key="NotConverter" TrueValue="False" FalseValue="True" />
        <conv:NullSafePropertyConverter x:Key="NullSafeConverter"/>

        <!-- Define default colors for Generals and Zero Hour -->
        <SolidColorBrush x:Key="GeneralsColor" Color="#BD5A0F" /> <!-- Dark orange/yellow -->
        <SolidColorBrush x:Key="ZeroHourColor" Color="#1B6575" /> <!-- Dark teal/blue -->
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Profile card styles -->
        <Style Selector="Border.profile-card">
            <Setter Property="Background" Value="#2A2A2A" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0 0 20 20" />
            <Setter Property="Width" Value="400" />
            <Setter Property="Height" Value="300" />
            <Setter Property="BoxShadow" Value="0 2 10 0 #30000000" />
            <Setter Property="Transitions">
                <Setter.Value>
                    <Transitions>
                        <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" />
                    </Transitions>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Border.profile-card:pointerover">
            <Setter Property="BoxShadow" Value="0 4 15 0 #40000000" />
            <Setter Property="RenderTransform" Value="translate(0px, -2px)" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <!-- Button styles -->
        <Style Selector="Button.profile-action">
            <Setter Property="Padding" Value="14 8" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="Background" Value="#44000000" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BorderBrush" Value="#50FFFFFF" />
            <!-- Use Button Template with Border supporting BoxShadow -->
            <Setter Property="Template">
                <ControlTemplate>
                    <Border BoxShadow="0 1 3 #40000000"
                        Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        CornerRadius="{TemplateBinding CornerRadius}">
                        <ContentPresenter Content="{TemplateBinding Content}"
                            ContentTemplate="{TemplateBinding ContentTemplate}"
                            Padding="{TemplateBinding Padding}"
                            HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                            VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
                    </Border>
                </ControlTemplate>
            </Setter>
        </Style>

        <Style Selector="Button.launch-button">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="MinWidth" Value="110" />
            <Setter Property="Background" Value="#44000000" />
        </Style>

        <Style Selector="Button.edit-button">
            <Setter Property="Background" Value="#44444444" />
            <Setter Property="Width" Value="34" />
            <Setter Property="Height" Value="34" />
            <Setter Property="Padding" Value="5" />
            <Setter Property="CornerRadius" Value="17" />
            <Setter Property="ToolTip.Tip" Value="Edit profile" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BorderBrush" Value="#30FFFFFF" />
            <!-- Use Button Template with Border supporting BoxShadow -->
            <Setter Property="Template">
                <ControlTemplate>
                    <Border BoxShadow="0 1 3 #40000000"
                        Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        CornerRadius="{TemplateBinding CornerRadius}">
                        <ContentPresenter Content="{TemplateBinding Content}"
                            ContentTemplate="{TemplateBinding ContentTemplate}"
                            Padding="{TemplateBinding Padding}"
                            HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                            VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
                    </Border>
                </ControlTemplate>
            </Setter>
            <Setter Property="Transitions">
                <Setter.Value>
                    <Transitions>
                        <BrushTransition Property="Background" Duration="0:0:0.2" />
                    </Transitions>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Button.edit-button:pointerover">
            <Setter Property="Background" Value="#66555555" />
        </Style>

        <!-- Plus button style -->
        <Style Selector="Button.add-profile-button">
            <Setter Property="Background" Value="#333333" />
            <Setter Property="Width" Value="400" />
            <Setter Property="Height" Value="300" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="BorderBrush" Value="#444444" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="Margin" Value="0 0 20 20" />
            <Setter Property="Transitions">
                <Setter.Value>
                    <Transitions>
                        <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" />
                    </Transitions>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Button.add-profile-button:pointerover">
            <Setter Property="RenderTransform" Value="scale(1.02)" />
            <Setter Property="Background" Value="#383838" />
        </Style>

        <!-- Delete button style - make it use accent red -->
        <Style Selector="Button.delete-button">
            <Setter Property="Background" Value="#EF4444" /> <!-- Red accent -->
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="#B91C1C" /> <!-- Darker red border -->
            <Setter Property="BorderThickness" Value="1" />
        </Style>
        <Style Selector="Button.delete-button:pointerover">
            <Setter Property="Background" Value="#B91C1C" /> <!-- Even darker red on hover -->
        </Style>

        <!-- Enhanced badge style for profile cards -->
        <Style Selector="Border.profile-badge">
            <Setter Property="Background" Value="#50000000" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="6,2" />
            <Setter Property="Margin" Value="0,0,6,6" />
            <Setter Property="BorderBrush" Value="{Binding $parent[Border].Background}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BoxShadow" Value="0 1 3 0 #20000000" />
        </Style>

        <Style Selector="TextBlock.badge-text">
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <!-- Source badge styles -->
        <Style Selector="Border.source-badge">
            <Setter Property="Background" Value="#40000000" />
            <Setter Property="CornerRadius" Value="3" />
            <Setter Property="Padding" Value="5,1" />
            <Setter Property="Margin" Value="0,4,5,0" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto, *">
        <!-- Row 0: Collapsible Header Container -->
        <Grid Grid.Row="0"
              Background="Transparent"
              PointerEntered="HeaderZone_PointerEntered"
              PointerExited="HeaderZone_PointerExited">
            <!-- Persistent hit-test area that ensures the Grid is Tall enough even when collapsed -->
            <Panel Height="60"
                   VerticalAlignment="Top"
                   IsHitTestVisible="False" />

            <!-- Animated Header Content -->
            <Border Classes="header-container" ClipToBounds="True">
                <Border.Styles>
                    <Style Selector="Border.header-container">
                        <Setter Property="Transitions">
                            <Transitions>
                                <DoubleTransition Property="MaxHeight" Duration="0:0:0.4" Easing="CubicEaseOut" />
                                <DoubleTransition Property="Opacity" Duration="0:0:0.4" Easing="CubicEaseOut" />
                            </Transitions>
                        </Setter>
                    </Style>
                </Border.Styles>

                <!-- Use HeaderMaxHeightConverter and HeaderOpacityConverter -->
                <Border.MaxHeight>
                    <Binding Path="IsHeaderExpanded" Converter="{StaticResource HeaderMaxHeightConverter}" />
                </Border.MaxHeight>

                <Border.Opacity>
                    <Binding Path="IsHeaderExpanded" Converter="{StaticResource HeaderOpacityConverter}" />
                </Border.Opacity>

                <StackPanel Margin="0,0,0,10">
                    <!-- Title and Info -->
                    <Grid ColumnDefinitions="*,Auto" Margin="20,16,20,8">
                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center">
                            <TextBlock Text="Game Profiles" FontSize="20" FontWeight="SemiBold"
                                Foreground="White" Margin="0 0 0 4" />
                            <TextBlock Text="Select a profile to launch or create a new one"
                                Foreground="#AAAAAA" FontSize="13" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
                           <Button Name="EditModeToggle"
                                Command="{Binding ToggleEditModeCommand, Mode=OneWay}"
                                Background="{Binding IsEditMode, Converter={StaticResource EditModeToggleBackgroundConverter}, Mode=OneWay}"
                                ToolTip.Tip="Toggle Edit Mode"
                                Width="42" Height="42"
                                CornerRadius="21"
                                Padding="0">
                                <Grid>
                                    <PathIcon
                                        Data="M20.71,4.04C21.1,3.65 21.1,3 20.71,2.63L18.37,0.29C18,-.1 17.35,-.1 16.96,0.29L15.12,2.12L18.87,5.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"
                                        Width="18" Height="18"
                                        Foreground="White"
                                        IsVisible="{Binding !IsEditMode, Mode=OneWay}" />
                                    <PathIcon
                                        Data="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19M17,11V13H7V11H17M13,15V17H7V15H13Z"
                                        Width="18" Height="18"
                                        Foreground="White"
                                        IsVisible="{Binding IsEditMode, Mode=OneWay}" />
                                </Grid>
                            </Button>

                        <Panel Grid.Column="2">
                            <!-- Scan Button -->
                            <Button Command="{Binding ScanForGamesCommand}"
                                    Content="SCAN"
                                    Classes="outline"
                                    IsVisible="{Binding !IsScanning}" />

                            <!-- Loading UI -->
                            <StackPanel Orientation="Horizontal" Spacing="12" IsVisible="{Binding IsScanning}">
                                <TextBlock Text="Scanning..."
                                           VerticalAlignment="Center"
                                           Foreground="#DDDDDD"
                                           FontWeight="SemiBold"
                                           FontSize="14" />
                                <ProgressBar IsIndeterminate="True"
                                             Width="120"
                                             Height="2"
                                             VerticalAlignment="Center"
                                             Background="#30FFFFFF"
                                             Foreground="White" />
                            </StackPanel>
                        </Panel>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Row 1: Main Content (Game Profiles List) -->
        <ScrollViewer Grid.Row="1" Margin="10">
            <StackPanel>
                <ItemsControl ItemsSource="{Binding Profiles}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <!-- Wrap panel for responsive layout -->
                            <WrapPanel Orientation="Horizontal"
                                      HorizontalAlignment="Center" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.DataTemplates>
                        <!-- Template for Add New Profile Item (Must be first to match subclass) -->
                        <DataTemplate DataType="vm:AddProfileItemViewModel">
                            <Button Classes="add-profile-button"
                                    Command="{Binding $parent[ItemsControl].((vm:GameProfileLauncherViewModel)DataContext).CreateNewProfileCommand}">
                                <StackPanel>
                                    <PathIcon Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"
                                        Foreground="#BBBBBB"
                                        Width="32"
                                        Height="32" />
                                    <TextBlock Text="Add New Profile"
                                        Foreground="#BBBBBB"
                                        Margin="0,10,0,0"
                                        FontSize="13" />
                                </StackPanel>
                            </Button>
                        </DataTemplate>

                        <!-- Template for Profile Items -->
                        <DataTemplate DataType="vm:GameProfileItemViewModel">
                            <views:GameProfileCardView DataContext="{Binding}"/>
                        </DataTemplate>
                    </ItemsControl.DataTemplates>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
