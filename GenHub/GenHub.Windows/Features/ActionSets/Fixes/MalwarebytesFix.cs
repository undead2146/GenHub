namespace GenHub.Windows.Features.ActionSets.Fixes;

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Threading;
using System.Threading.Tasks;
using GenHub.Core.Features.ActionSets;
using GenHub.Core.Models.GameInstallations;
using Microsoft.Extensions.Logging;

/// <summary>
/// Fix that provides Malwarebytes compatibility guidance for game executables.
/// This fix checks for Malwarebytes installation and provides instructions
/// to add game folders to Malwarebytes exclusions to prevent interference.
/// </summary>
public class MalwarebytesFix(ILogger<MalwarebytesFix> logger) : BaseActionSet(logger)
{
    private readonly ILogger<MalwarebytesFix> _logger = logger;

    /// <inheritdoc/>
    public override string Id => "MalwarebytesFix";

    /// <inheritdoc/>
    public override string Title => "Malwarebytes Compatibility";

    /// <inheritdoc/>
    public override bool IsCoreFix => false;

    /// <inheritdoc/>
    public override bool IsCrucialFix => false;

    /// <inheritdoc/>
    public override Task<bool> IsApplicableAsync(GameInstallation installation)
    {
        return Task.FromResult(installation.HasGenerals || installation.HasZeroHour);
    }

    /// <inheritdoc/>
    public override Task<bool> IsAppliedAsync(GameInstallation installation)
    {
        try
        {
            // Check if Malwarebytes is installed
            var mbamInstalled = IsMalwarebytesInstalled();

            if (!mbamInstalled)
            {
                // If Malwarebytes is not installed, consider this fix "applied"
                return Task.FromResult(true);
            }

            // Check if game folders are in Malwarebytes exclusions
            // Note: Malwarebytes exclusions are stored in a proprietary format
            // and cannot be easily checked programmatically without their API
            // For now, we'll consider this fix as informational
            return Task.FromResult(false);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error checking Malwarebytes compatibility status");
            return Task.FromResult(false);
        }
    }

    /// <inheritdoc/>
    protected override Task<ActionSetResult> ApplyInternalAsync(GameInstallation installation, CancellationToken cancellationToken)
    {
        var details = new List<string>();

        try
        {
            details.Add("Malwarebytes Compatibility - Informational");
            details.Add(string.Empty);

            var mbamInstalled = IsMalwarebytesInstalled();

            if (!mbamInstalled)
            {
                details.Add("✓ Malwarebytes is not installed");
                details.Add("  No action needed");
                _logger.LogInformation("Malwarebytes is not installed. No action needed.");
                return Task.FromResult(new ActionSetResult(true, null, details));
            }

            // Provide guidance for adding exclusions
            var paths = new List<string>();

            if (installation.HasGenerals)
            {
                paths.Add(installation.GeneralsPath);
            }

            if (installation.HasZeroHour)
            {
                paths.Add(installation.ZeroHourPath);
            }

            details.Add("⚠ Malwarebytes detected");
            details.Add("  Please add the following folders to exclusions:");
            details.Add(string.Empty);
            foreach (var path in paths)
            {
                details.Add($"  • {path}");
            }

            details.Add(string.Empty);
            details.Add("To add exclusions in Malwarebytes:");
            details.Add("  1. Open Malwarebytes");
            details.Add("  2. Go to Settings > Exclusions");
            details.Add("  3. Click 'Add Folder' and select the game folders listed above");
            details.Add("  4. Click 'Done' to save changes");

            _logger.LogWarning("Malwarebytes is installed. Please manually add the following folders to Malwarebytes exclusions:");
            foreach (var path in paths)
            {
                _logger.LogWarning("  - {Path}", path);
            }

            _logger.LogInformation("To add exclusions in Malwarebytes:");
            _logger.LogInformation("1. Open Malwarebytes");
            _logger.LogInformation("2. Go to Settings > Exclusions");
            _logger.LogInformation("3. Click 'Add Folder' and select the game folders listed above");
            _logger.LogInformation("4. Click 'Done' to save changes");

            return Task.FromResult(new ActionSetResult(true, "Please manually add game folders to Malwarebytes exclusions. See details for instructions.", details));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error applying Malwarebytes compatibility fix");
            details.Add($"✗ Error: {ex.Message}");
            return Task.FromResult(new ActionSetResult(false, ex.Message, details));
        }
    }

    /// <inheritdoc/>
    protected override Task<ActionSetResult> UndoInternalAsync(GameInstallation installation, CancellationToken cancellationToken)
    {
        _logger.LogWarning("Malwarebytes Fix is informational only. No undo action needed.");
        return Task.FromResult(new ActionSetResult(true));
    }

    private bool IsMalwarebytesInstalled()
    {
        try
        {
            // Check for common Malwarebytes installation paths
            var programFiles = Environment.GetFolderPath(Environment.SpecialFolder.ProgramFilesX86);
            var mbamPaths = new[]
            {
                Path.Combine(programFiles, "Malwarebytes", "Anti-Malware", "mbam.exe"),
                Path.Combine(programFiles, "Malwarebytes", "Anti-Malware", "mbamtray.exe"),
                Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles), "Malwarebytes", "Anti-Malware", "mbam.exe"),
            };

            foreach (var path in mbamPaths)
            {
                if (File.Exists(path))
                {
                    return true;
                }
            }

            // Check for Malwarebytes in registry
            using var key = Microsoft.Win32.Registry.LocalMachine.OpenSubKey(
                @"SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
                false);

            if (key != null)
            {
                foreach (var subKeyName in key.GetSubKeyNames())
                {
                    using var subKey = key.OpenSubKey(subKeyName, false);
                    if (subKey != null)
                    {
                        var displayName = subKey.GetValue("DisplayName") as string;
                        if (displayName != null && displayName.Contains("Malwarebytes", StringComparison.OrdinalIgnoreCase))
                        {
                            return true;
                        }
                    }
                }
            }

            return false;
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Error checking for Malwarebytes installation");
            return false;
        }
    }
}
